{% extends "base.html" %}

{% block title %}Add New Song - Guitar Practice{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Add New Song
                </h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="artist" class="form-label">Artist</label>
                        <input type="text" class="form-control" id="artist" name="artist">
                    </div>
                    
                    <div class="mb-3">
                        <label for="time_signature" class="form-label">Time Signature *</label>
                        <input type="text" class="form-control" id="time_signature" name="time_signature" 
                               placeholder="e.g., 4/4" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bpm" class="form-label">BPM *</label>
                        <input type="number" class="form-control" id="bpm" name="bpm" 
                               min="20" max="300" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="capo" class="form-label">Capo Position</label>
                        <select class="form-select" id="capo" name="capo">
                            <option value="None">None</option>
                            <option value="1">1st fret</option>
                            <option value="2">2nd fret</option>
                            <option value="3">3rd fret</option>
                            <option value="4">4th fret</option>
                            <option value="5">5th fret</option>
                            <option value="6">6th fret</option>
                            <option value="7">7th fret</option>
                            <option value="8">8th fret</option>
                            <option value="9">9th fret</option>
                            <option value="10">10th fret</option>
                            <option value="11">11th fret</option>
                            <option value="12">12th fret</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="chord_progression" class="form-label">Chord Progression *</label>
                        <textarea class="form-control" id="chord_progression" name="chord_progression" 
                                  rows="2" style="font-size: 0.9rem; line-height: 1.2;" required></textarea>
                        <div class="form-text">Enter chords separated by spaces or new lines</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="strumming_pattern" class="form-label">Strumming Pattern *</label>
                        <svg id="strummingPatternEditor" width="400" height="80"></svg>
                        <input type="hidden" id="strumming_pattern" name="strumming_pattern" value="" required>
                        <div class="form-text">Click on the pattern slots to change strum direction (↓, ↑, - , X)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="4"></textarea>
                        <div class="form-text">Any additional notes or instructions</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Song
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const svg = document.getElementById('strummingPatternEditor');
    const hiddenInput = document.getElementById('strumming_pattern');
    const timeSignatureInput = document.getElementById('time_signature');
    
    const beatUnit = 4; // Number of 16th notes per beat
    let numberOfMeasures = 1; // Default to 1 measure
    let beatsPerMeasure = 4; // Default to 4/4 time
    let totalSlots = beatsPerMeasure * beatUnit * numberOfMeasures; // Total 16th note slots
    
    const slotWidth = 25; // Width of each 16th note slot
    const slotHeight = 30; // Height of each slot
    const startX = 10;
    const startY = 10;

    let strummingPattern = Array(totalSlots).fill('-'); // Initialize with rests

    const strummingSymbols = ['D', 'U', '-', 'X']; // Down, Up, Rest, Mute
    const displaySymbols = ['↓', '↑', '-', 'X'];

    // Function to parse time signature and get beats per measure
    function parseTimeSignature(timeSignatureStr) {
        const parts = (timeSignatureStr || '4/4').split('/');
        if (parts.length === 2) {
            const numerator = parseInt(parts[0]);
            const denominator = parseInt(parts[1]);
            // For strumming patterns, we count in terms of the main beats
            // So 4/4 = 4 beats, 3/4 = 3 beats, 6/8 = 2 beats (felt in 2), etc.
            if (denominator === 8 && numerator === 6) {
                return 2; // 6/8 is typically felt in 2
            } else if (denominator === 8 && numerator === 9) {
                return 3; // 9/8 is typically felt in 3
            } else if (denominator === 8 && numerator === 12) {
                return 4; // 12/8 is typically felt in 4
            } else {
                return numerator; // For most time signatures, use the numerator
            }
        }
        return 4; // Default to 4/4 if parsing fails
    }

    function updateTimeSignature() {
        const timeSignature = timeSignatureInput.value || '4/4';
        beatsPerMeasure = parseTimeSignature(timeSignature);
        
        // Recalculate total slots based on new time signature
        const newTotalSlots = beatsPerMeasure * beatUnit * numberOfMeasures;
        
        // Adjust strumming pattern array
        if (newTotalSlots > totalSlots) {
            // If increasing slots, pad with rests
            strummingPattern = strummingPattern.concat(Array(newTotalSlots - totalSlots).fill('-'));
        } else if (newTotalSlots < totalSlots) {
            // If decreasing slots, truncate the array
            strummingPattern = strummingPattern.slice(0, newTotalSlots);
        }
        
        totalSlots = newTotalSlots;
        drawGrid();
        updateHiddenInput();
    }

    function drawGrid() {
        // Calculate SVG dimensions
        const svgWidth = startX + (beatsPerMeasure * beatUnit * slotWidth * numberOfMeasures) + startX;
        const svgHeight = startY + slotHeight + 40; // Extra space for beat numbers
        
        svg.setAttribute('width', svgWidth);
        svg.setAttribute('height', svgHeight);
        svg.innerHTML = ''; // Clear previous drawings

        // Draw vertical lines for beats and measure boundaries
        for (let measure = 0; measure < numberOfMeasures; measure++) {
            for (let beat = 0; beat <= beatsPerMeasure; beat++) {
                const x = startX + (measure * beatsPerMeasure + beat) * beatUnit * slotWidth;
                const isMainBeat = beat === 0 || beat === beatsPerMeasure;
                const isMeasureBoundary = beat === 0 && measure > 0;
                
                // Thicker lines for measure boundaries, regular thick lines for beats
                const strokeWidth = isMeasureBoundary ? '3' : (isMainBeat ? '2' : '2');
                svg.innerHTML += `<line x1="${x}" y1="${startY}" x2="${x}" y2="${startY + slotHeight}" stroke="black" stroke-width="${strokeWidth}"/>`;
                
                // Add beat numbers above beats (not at measure boundaries)
                if (beat < beatsPerMeasure) {
                    const beatNumber = beat + 1;
                    const beatLineX = x; // Position directly above the beat line
                    svg.innerHTML += `<text x="${beatLineX}" y="${startY - 5}" text-anchor="middle" font-size="12">${beatNumber}</text>`;
                }
            }
        }

        // Draw vertical lines for 16th note divisions
        for (let i = 0; i <= totalSlots; i++) {
            const x = startX + i * slotWidth;
            const isOnBeat = i % beatUnit === 0;
            
            if (!isOnBeat) {
                svg.innerHTML += `<line x1="${x}" y1="${startY}" x2="${x}" y2="${startY + slotHeight}" stroke="grey" stroke-width="1"/>`;
            }
        }

        // Draw horizontal lines (top and bottom)
        svg.innerHTML += `<line x1="${startX}" y1="${startY}" x2="${startX + totalSlots * slotWidth}" y2="${startY}" stroke="black" stroke-width="2"/>`;
        svg.innerHTML += `<line x1="${startX}" y1="${startY + slotHeight}" x2="${startX + totalSlots * slotWidth}" y2="${startY + slotHeight}" stroke="black" stroke-width="2"/>`;

        // Draw interactive slots and symbols
        for (let i = 0; i < totalSlots; i++) {
            const x = startX + i * slotWidth;
            const y = startY;

            // Create a clickable area for each slot
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', slotWidth);
            rect.setAttribute('height', slotHeight);
            rect.setAttribute('fill', 'transparent'); // Make it invisible but clickable
            rect.setAttribute('data-index', i); // Store the index of the slot
            svg.appendChild(rect);

            // Add event listener to the rect
            rect.addEventListener('click', handleClick);
            
            // Add symbol text
            const symbolText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            symbolText.setAttribute('x', x + slotWidth / 2);
            symbolText.setAttribute('y', y + slotHeight / 2 + 5); // Adjust for vertical centering
            symbolText.setAttribute('text-anchor', 'middle');
            symbolText.setAttribute('font-size', '18');
            symbolText.setAttribute('fill', 'black');
            symbolText.classList.add('strum-symbol'); // Add a class for easy selection
            
            const currentSymbol = strummingPattern[i] || '-';
            const symbolIndex = strummingSymbols.indexOf(currentSymbol);
            symbolText.textContent = (symbolIndex !== -1) ? displaySymbols[symbolIndex] : '-';
            symbolText.setAttribute('data-index', i); // Store the index on the text too
            svg.appendChild(symbolText);
        }
    }

    function handleClick(event) {
        const index = parseInt(event.target.getAttribute('data-index'));
        const currentSymbol = strummingPattern[index];
        const currentIndex = strummingSymbols.indexOf(currentSymbol);
        const nextIndex = (currentIndex + 1) % strummingSymbols.length;
        const nextSymbol = strummingSymbols[nextIndex];
        
        strummingPattern[index] = nextSymbol; // Update the internal pattern array
        
        // Update the displayed symbol in the SVG
        const symbolTextElement = svg.querySelector(`.strum-symbol[data-index='${index}']`);
        if(symbolTextElement) {
            symbolTextElement.textContent = displaySymbols[nextIndex];
        }

        updateHiddenInput(); // Update the hidden input field
    }

    function updateHiddenInput() {
        hiddenInput.value = JSON.stringify(strummingPattern);
    }

    // Add event listener to time signature input
    timeSignatureInput.addEventListener('input', updateTimeSignature);
    timeSignatureInput.addEventListener('change', updateTimeSignature);

    // Initial setup
    updateTimeSignature(); // This will set up the initial grid based on default 4/4
    
    // CRITICAL: Update the hidden input with the initial pattern
    updateHiddenInput();
</script>
{% endblock %} 