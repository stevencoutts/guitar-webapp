{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="row g-4">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Song Header -->
            <div class="song-header-modern mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="song-info">
                        <h1 class="song-title">{{ song.title }}</h1>
                            {% if song.artist %}
                        <p class="song-artist">by {{ song.artist }}</p>
                        {% endif %}
                        <div class="song-meta">
                            <span class="meta-badge">{{ song.time_signature }}</span>
                            <span class="meta-badge">{{ song.bpm }} BPM</span>
                            {% if song.capo != 'None' %}
                            <span class="meta-badge">Capo {{ song.capo }}</span>
                            {% endif %}
                        </div>
                        </div>
                        <div class="dropdown">
                        <button class="btn btn-ghost" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-h"></i>
                            </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('edit_song', song_id=song.id) }}">
                                    <i class="fas fa-edit me-2"></i>Edit Song
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="POST" action="{{ url_for('delete_song', song_id=song.id) }}" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="dropdown-item text-danger" 
                                                onclick="return confirm('Are you sure you want to delete this song?')">
                                        <i class="fas fa-trash me-2"></i>Delete Song
                                        </button>
                                    </form>
                                </li>
                            </ul>
                    </div>
                </div>
            </div>

            {% if song.strumming_pattern %}
            <!-- Strumming Pattern Card -->
            <div class="card-modern mb-4">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-guitar"></i>
                        Strumming Pattern
                    </h3>
                </div>
                <div class="card-body-modern">
                    <div id="main-strumming-pattern-display"></div>
                </div>
            </div>
                        {% endif %}

            <!-- Chord Progression Card -->
            <div class="card-modern mb-4">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-music"></i>
                        Chord Progression
                    </h3>
                    <div class="btn-group-modern" role="group">
                        <button type="button" class="btn-toggle" id="view-simple-btn" onclick="toggleProgessionView('simple')">
                            Simple
                        </button>
                        <button type="button" class="btn-toggle active" id="view-formatted-btn" onclick="toggleProgessionView('formatted')">
                            Chart
                        </button>
                    </div>
                </div>

                <div class="card-body-modern">
                    <!-- Simple View -->
                    <div id="chord-progression-simple" class="chord-progression-view" style="display: none;">
                        <div class="progression-simple">{{ song.chord_progression }}</div>
            </div>

                    <!-- Chart View -->
                    <div id="chord-progression-formatted" class="chord-progression-view">
                        <div class="progression-controls mb-4">
                            <div class="d-flex gap-4 align-items-center flex-wrap">
                                <div class="form-check-modern">
                                    <input class="form-check-input" type="checkbox" id="show-bar-numbers" checked onchange="updateFormattedView()">
                                    <label class="form-check-label" for="show-bar-numbers">Line numbers</label>
                                </div>
                                <div class="form-check-modern">
                                    <input class="form-check-input" type="checkbox" id="highlight-on-click" checked>
                                    <label class="form-check-label" for="highlight-on-click">Click to highlight</label>
                                </div>
                            </div>
                        </div>
                        <div class="formatted-progression-container">
                            <div id="formatted-progression" class="formatted-progression">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chord Library Card -->
            <div class="card-modern mb-4">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-hand-paper"></i>
                        Chord Library
                    </h3>
                    </div>
                <div class="card-body-modern">
                    <div class="chord-grid-main">
                        {% if ordered_unique_chords %}
                            {% for chord_name in ordered_unique_chords %}
                                {% set shapes = chord_shapes_dict.get(chord_name, []) %}
                                <div class="chord-card-modern" data-chord-index="{{ loop.index0 }}" data-chord-name="{{ chord_name }}">
                                    <div class="chord-header">
                                        <h4 class="chord-name">{{ chord_name }}</h4>
                                                {% if shapes|length > 1 %}
                                        <select class="variant-select" onchange="changeChordVariant(this)">
                                                            {% for shape in shapes %}
                                                                {% set variant_value = shape.variant if shape.variant is not none else '' %}
                                                                {% set variant_display = shape.variant if shape.variant is not none and shape.variant != '' else 'Default' %}
                                                {% set initial_shape = initial_shapes_dict.get(chord_name) %}
                                                <option value="{{ variant_value }}" {% if initial_shape and initial_shape.variant == variant_value %}selected{% endif %}>
                                                    {{ variant_display }}
                                                </option>
                                                            {% endfor %}
                                        </select>
                                                {% endif %}
                                            </div>
                                    <div class="chord-diagram">
                                            {{ initial_diagram_svgs.get(chord_name) | safe }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <p>No chord shapes found.</p>
                            <a href="{{ url_for('admin_chords') }}" class="btn-primary-modern">Add Chords</a>
            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notes Card -->
            {% if song.notes %}
            <div class="card-modern">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-sticky-note"></i>
                        Notes
                    </h3>
                            </div>
                <div class="card-body-modern">
                    <div class="notes-content">{{ song.notes }}</div>
                        </div>
                        </div>
            {% endif %}
                    </div>
                    
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sidebar-modern">
                <!-- Sidebar content removed - practice tools moved to floating controls -->
                                </div>
                                    </div>
                                </div>
                                    </div>

<!-- Floating Audio Controls Panel -->
<div id="floating-audio-controls" class="floating-controls">
    <div class="floating-controls-header">
        <i class="fas fa-music me-2"></i>
        <span>Audio Controls</span>
        <button id="toggle-floating-controls" class="btn-icon" title="Minimize/Maximize">
            <i class="fas fa-minus"></i>
        </button>
            </div>

    <div id="floating-controls-content" class="floating-controls-content">
        <!-- Tempo Controls -->
        <div class="tempo-section">
            <div class="tempo-display">
                <span id="current-bpm">{{ song.bpm }}</span>
                <small>BPM</small>
            </div>
            <div class="tempo-controls">
                <button class="btn-tempo" onclick="adjustTempo(-10)" title="Decrease 10 BPM">
                    <i class="fas fa-backward"></i>
                        </button>
                <button class="btn-tempo" onclick="adjustTempo(-5)" title="Decrease 5 BPM">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="btn-tempo" onclick="resetTempo()" title="Reset to original BPM">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="btn-tempo" onclick="adjustTempo(5)" title="Increase 5 BPM">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="btn-tempo" onclick="adjustTempo(10)" title="Increase 10 BPM">
                    <i class="fas fa-forward"></i>
                        </button>
                    </div>
                </div>
        
        <!-- Metronome Controls -->
        <div class="control-section">
            <button class="btn-floating metronome-btn" onclick="toggleMetronome()" id="floating-metronome-btn">
                <i class="fas fa-clock me-2"></i>
                <span id="metronome-status">Start Metronome</span>
            </button>
            <div class="floating-metronome-dots" id="floating-metronome-dots">
                <!-- Dots will be generated dynamically -->
                </div>
        </div>

        {% if song.strumming_pattern %}
        <!-- Strumming Pattern Controls -->
        <div class="control-section">
            <button class="btn-floating strumming-btn" onclick="toggleStrummingPattern()" id="floating-strumming-btn">
                <i class="fas fa-guitar me-2"></i>
                <span id="strumming-status">Play Pattern</span>
                        </button>
            <!-- Strumming Pattern Display -->
            <div class="floating-strumming-display">
                <div id="floating-strumming-pattern-display"></div>
                    </div>
                        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Modern Design System */
    :root {
        --primary-color: #d32f2f;
        --primary-dark: #b71c1c;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --bg-white: #ffffff;
        --bg-gray-50: #f9fafb;
        --bg-gray-100: #f3f4f6;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
    }

    /* Reset and Base */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        background-color: var(--bg-gray-50);
        line-height: 1.6;
    }

    /* Song Header */
    .song-header-modern {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    .song-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
    }

    .song-artist {
        font-size: 1.25rem;
        color: var(--text-secondary);
        margin: 0 0 1rem 0;
        font-weight: 500;
    }

    .song-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .meta-badge {
        background: var(--bg-gray-100);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid var(--border-color);
    }

    /* Modern Cards */
    .card-modern {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .card-header-modern {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-gray-50);
        display: flex;
        justify-content: between;
        align-items: center;
        gap: 1rem;
    }

    .card-title-modern {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .card-title-modern i {
        color: var(--primary-color);
        font-size: 1.125rem;
    }

    .card-body-modern {
        padding: 1.5rem;
        width: 100%;
        box-sizing: border-box;
    }

    /* Buttons */
    .btn-primary-modern {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .btn-primary-modern:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary-modern {
        background: var(--bg-white);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-secondary-modern:hover {
        background: var(--bg-gray-50);
        border-color: var(--text-secondary);
    }

    .btn-ghost {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 0.5rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-ghost:hover {
        background: var(--bg-gray-100);
        color: var(--text-primary);
    }

    .btn-ghost-small {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-ghost-small:hover {
        background: var(--bg-gray-50);
        border-color: var(--text-secondary);
    }

    /* Toggle Buttons */
    .btn-group-modern {
        display: flex;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .btn-toggle {
        background: var(--bg-white);
        color: var(--text-secondary);
        border: none;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border-right: 1px solid var(--border-color);
    }

    .btn-toggle:last-child {
        border-right: none;
    }

    .btn-toggle:hover {
        background: var(--bg-gray-50);
    }

    .btn-toggle.active {
        background: var(--primary-color);
        color: white;
    }

    /* Chord Progression */
    .progression-simple {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 2rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 1rem;
        line-height: 1.8;
        white-space: pre-wrap;
        color: var(--text-primary);
        /* Remove max-height and overflow-y to always show all content */
        max-height: none;
        overflow-y: visible;
    }

    /* Form Controls */
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .control-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .form-select-modern {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        background: var(--bg-white);
        color: var(--text-primary);
        min-width: 80px;
    }

    .form-check-modern {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-check-modern label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        cursor: pointer;
    }

    /* Sidebar */
    .sidebar-modern {
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
    }

    /* Practice Tools */
    .practice-controls {
        display: flex;
        flex-direction: column;
    }

    .metronome-display {
        text-align: center;
        display: none;
    }

    .metronome-dots {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-gray-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }

    .metronome-dot {
        width: 12px;
        height: 12px;
        background: var(--border-color);
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .metronome-dot.active {
        background: var(--primary-color);
        transform: scale(1.5);
        box-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
    }

    /* Chord Grid */
    .chord-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.35rem;
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
        margin: 0;
    }

    /* Chord Grid - Main Content Area (wider) */
    .chord-grid-main {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        width: 100%;
    }

    .chord-card-modern {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.35rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        min-height: 105px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 100%;
        box-sizing: border-box;
    }

    /* Larger chord cards for main content area */
    .chord-grid-main .chord-card-modern {
        padding: 0.3rem;
        min-height: 250px;
        width: 100%;
    }

    .chord-grid-main .chord-name {
            font-size: 0.9rem;
        margin: 0 0 0.3rem 0;
    }

    .chord-grid-main .chord-diagram {
        min-height: 190px;
        max-height: 210px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-grow: 1;
        overflow: visible;
        padding: 0.1rem 0.1rem 0.3rem 0.1rem;
        box-sizing: border-box;
    }

    .chord-grid-main .chord-diagram svg {
        width: 90%;
        height: auto;
        max-height: 220px;
        display: block;
    }

    .chord-card-modern:hover {
        background: var(--bg-white);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .chord-card-modern.highlighted {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-dark);
    }

    .chord-header {
        margin-bottom: 0.2rem;
        flex-shrink: 0;
        width: 100%;
    }
    
    .chord-name {
        font-size: 0.75rem;
        font-weight: 600;
        margin: 0 0 0.15rem 0;
        color: var(--text-primary);
        line-height: 1.1;
    }

    .chord-card-modern.highlighted .chord-name {
        color: white;
    }

    .variant-select {
        font-size: 0.55rem;
        padding: 0.1rem 0.2rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        background: var(--bg-white);
        width: 100%;
    }

    .chord-diagram {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
        min-height: 65px;
        overflow: visible;
        width: 100%;
    }
    
    .chord-diagram svg {
        max-width: 100%;
        max-height: 75px;
        width: auto;
        height: auto;
    }

    /* Notes */
    .notes-content {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
        color: var(--text-primary);
    }

    /* Strumming Pattern */
    #strumming-pattern-display svg {
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background: var(--bg-gray-50);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    /* Scrollbars */
    .chord-grid::-webkit-scrollbar,
    .progression-simple::-webkit-scrollbar,
    .sidebar-modern::-webkit-scrollbar {
        width: 6px;
    }

    .chord-grid::-webkit-scrollbar-track,
    .progression-simple::-webkit-scrollbar-track,
    .sidebar-modern::-webkit-scrollbar-track {
        background: var(--bg-gray-100);
        border-radius: 3px;
    }

    .chord-grid::-webkit-scrollbar-thumb,
    .progression-simple::-webkit-scrollbar-thumb,
    .sidebar-modern::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }

    .chord-grid::-webkit-scrollbar-thumb:hover,
    .progression-simple::-webkit-scrollbar-thumb:hover,
    .sidebar-modern::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }

    /* Responsive Design */
    @media (max-width: 991.98px) {
        .sidebar-modern {
            position: static;
            max-height: none;
            margin-top: 2rem;
        }

        .song-title {
            font-size: 2rem;
        }

        .chord-card-modern {
            padding: 0.3rem;
            min-height: 95px;
        }

        .chord-diagram {
            min-height: 60px;
        }

        .chord-diagram svg {
            max-height: 70px;
        }

        /* Main chord grid - reduce to 3 columns on tablets */
        .chord-grid-main {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .chord-grid-main .chord-card-modern {
            padding: 0.5rem;
            min-height: 120px;
        }

        .chord-grid-main .chord-diagram svg {
            max-height: 90px;
        }
    }

    @media (max-width: 767.98px) {
        .song-header-modern,
        .card-body-modern {
        padding: 1rem;
        }

        .card-header-modern {
            padding: 0.75rem 1rem;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }

        .song-title {
            font-size: 1.75rem;
        }

        .meta-badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .chord-grid {
            gap: 0.25rem;
        }

        .chord-card-modern {
            min-height: 85px;
            padding: 0.25rem;
        }

        .chord-name {
            font-size: 0.7rem;
        }

        .chord-diagram {
            min-height: 55px;
        }

        .chord-diagram svg {
            max-height: 65px;
        }

        /* Main chord grid - 2 columns on mobile */
        .chord-grid-main {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .chord-grid-main .chord-card-modern {
            padding: 0.4rem;
            min-height: 110px;
        }

        .chord-grid-main .chord-name {
            font-size: 0.85rem;
        }

        .chord-grid-main .chord-diagram svg {
            max-height: 80px;
        }

        .progression-controls {
            flex-direction: column;
            gap: 1rem;
        }

        .progression-controls .d-flex {
            flex-direction: column;
            align-items: stretch !important;
        }
    }

    @media (max-width: 576px) {
        .chord-card-modern {
            min-height: 80px;
            padding: 0.2rem;
        }

        .chord-name {
            font-size: 0.65rem;
        }

        .chord-diagram {
            min-height: 50px;
        }

        .chord-diagram svg {
            max-height: 60px;
        }

        /* Main chord grid - keep 2 columns but smaller */
        .chord-grid-main .chord-card-modern {
            padding: 0.3rem;
            min-height: 100px;
        }

        .chord-grid-main .chord-name {
            font-size: 0.75rem;
        }

        .chord-grid-main .chord-diagram svg {
            max-height: 70px;
        }
    }

    /* Dropdown Improvements */
    .dropdown-menu {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        padding: 0.5rem;
    }

    .dropdown-item {
        border-radius: var(--radius-sm);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background: var(--bg-gray-50);
    }

    /* Formatted progression specific styles */
    .bar-container {
        margin-bottom: 1rem;
    }
    
    .bar-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }
    
    .bar-label-inline {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        margin-right: 1rem;
        align-self: center;
        flex-shrink: 0;
        min-width: 3.5rem;
    }
    
    .chord-boxes-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }
    
    .chord-box {
        background: var(--bg-white);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        min-width: 3rem;
        text-align: center;
    }
    
    .chord-box:hover {
        background: var(--bg-gray-50);
        border-color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .chord-box.highlighted {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-dark);
        box-shadow: var(--shadow-md);
    }
    
    .half-measure-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding: 0.25rem;
        border-radius: var(--radius-md);
        background: rgba(211, 47, 47, 0.05);
        border: 1px dashed var(--primary-color);
    }
    
    .half-measure-chord {
        margin: 0;
        min-width: 2.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }

    /* Formatted progression specific styles */
    .progression-line {
        margin-bottom: 0.75rem;
        line-height: 1.8;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 1rem;
    }
    
    .line-number {
        font-size: 0.85rem;
        color: #6c757d;
        margin-right: 0.75rem;
        font-weight: 600;
    }
    
    .half-measure-container {
        background: rgba(211, 47, 47, 0.05);
        border-radius: 4px;
        padding: 0.1rem 0.3rem;
        margin: 0 0.2rem;
    }
    
    .pipe-separator {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .progression-chord {
        display: inline-block;
        min-width: 2.5rem;
        text-align: center;
        padding: 0.2rem 0.4rem;
        margin: 0 0.1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .progression-chord:hover {
        background-color: #e9ecef;
    }
    
    .progression-chord.highlighted {
        background-color: #d32f2f;
        color: white;
    }
    
    .chord-card-modern.highlighted {
        background-color: #d32f2f !important;
        color: white;
    }
    
    .chord-card-modern.highlighted .chord-name {
        color: white;
    }

    /* Floating Audio Controls */
    .floating-controls {
        position: fixed;
        top: 80px;
        right: 20px;
        transform: none;
        width: 320px;
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .floating-controls.minimized {
        transform: translateX(calc(100% - 60px));
    }

    .floating-controls-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        background: var(--bg-gray-50);
        border-bottom: 1px solid var(--border-color);
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        cursor: pointer;
        user-select: none;
    }

    .floating-controls-header span {
        font-weight: 600;
        color: var(--text-primary);
            font-size: 0.9rem;
        }
        
    .floating-controls-header i.fa-music {
        color: var(--primary-color);
    }

    .btn-icon {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }

    .btn-icon:hover {
        background: var(--bg-gray-100);
        color: var(--text-primary);
    }

    .floating-controls-content {
        padding: 1.25rem;
        transition: all 0.3s ease;
    }

    .floating-controls.minimized .floating-controls-content {
        display: none;
    }

    /* Tempo Section */
    .tempo-section {
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .tempo-display {
        margin-bottom: 1rem;
    }

    .tempo-display span {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        line-height: 1;
    }

    .tempo-display small {
        display: block;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        font-weight: 500;
    }

    .tempo-controls {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-tempo {
        background: var(--bg-gray-100);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.5rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-tempo:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        border-color: var(--primary-color);
    }

    .btn-tempo:active {
        transform: translateY(0);
    }

    /* Control Sections */
    .control-section {
        margin-bottom: 1rem;
    }

    .control-section:last-child {
        margin-bottom: 0;
    }

    .btn-floating {
        width: 100%;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
    }

    .btn-floating:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-floating.active {
        background: #e65100;
    }

    .btn-floating.strumming-btn {
        background: #2e7d32;
    }

    .btn-floating.strumming-btn:hover {
        background: #1b5e20;
    }

    .btn-floating.strumming-btn.active {
        background: #ff6f00;
    }

    /* Floating Metronome Dots */
    .floating-metronome-dots {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .floating-metronome-dots .metronome-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--bg-gray-100);
        border: 2px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .floating-metronome-dots .metronome-dot.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        transform: scale(1.2);
    }

    /* Floating Strumming Pattern Display */
    .floating-strumming-display {
        margin-top: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
        border-radius: var(--radius-sm);
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
    }

    .floating-strumming-display svg {
        width: 100%;
        height: auto;
        display: block;
        background: var(--bg-gray-50);
        border-radius: var(--radius-sm);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .floating-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            top: auto;
            width: 100%;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            transform: none;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }

        .floating-controls.minimized {
            transform: translateY(calc(100% - 60px));
        }

        .floating-controls-content {
            padding: 1rem;
        }

        .tempo-section {
            margin-bottom: 1rem;
        }

        .tempo-controls {
            gap: 0.25rem;
            justify-content: center;
        }

        .btn-tempo {
            width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }

        .tempo-display span {
            font-size: 1.75rem;
        }

        .btn-floating {
            padding: 0.625rem 1rem;
            font-size: 0.8rem;
        }

        .floating-strumming-display {
            margin-top: 0.5rem;
            max-height: 150px;
        }
    }

    @media (max-width: 480px) {
        .floating-controls-header,
        .floating-controls-content {
            padding: 0.75rem;
        }

        .tempo-section {
            margin-bottom: 0.75rem;
        }

        .control-section {
            margin-bottom: 0.75rem;
        }

        .tempo-display span {
            font-size: 1.5rem;
        }

        .btn-tempo {
            width: 28px;
            height: 28px;
            font-size: 0.7rem;
        }
    }

    /* Notes */
    .notes-content {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
        color: var(--text-primary);
    }

    /* Main Strumming Pattern Display */
    #main-strumming-pattern-display {
        max-height: 400px;
        overflow-y: auto;
    }

    #main-strumming-pattern-display svg {
        width: 100%;
        height: auto;
        display: block;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    /* Pulse animation for strumming arrows */
    @keyframes pulse-arrow {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.18);
        }
        100% {
            transform: scale(1);
        }
    }
    .pulse-arrow {
        animation: pulse-arrow 0.18s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        transform-origin: 50% 60%;
        transform-box: fill-box;
    }

    /* Add style for section headers */
    .progression-section-header {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-top: 2rem;
        margin-bottom: 0.5rem;
        letter-spacing: 0.01em;
    }
</style>

<script>
// Global variables
let isMetronomePlaying = false;
let metronomeInterval;
let strummingPatternData = [];
let currentProgressionView = 'simple';

// Audio context for sound generation
let audioContext;
let isAudioInitialized = false;

// Initialize audio context
function initializeAudio() {
    if (!isAudioInitialized) {
         audioContext = new (window.AudioContext || window.webkitAudioContext)();
        isAudioInitialized = true;
    }
    return audioContext;
     }

// Generate metronome click sound
function playMetronomeClick(isDownbeat = false) {
    const ctx = initializeAudio();

    // Create oscillator for the click
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    // Connect audio nodes
     oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    // Set frequency (higher for downbeat, lower for other beats)
    oscillator.frequency.value = isDownbeat ? 1000 : 800;
    oscillator.type = 'square';
    
    // Set volume envelope (quick attack and decay for click sound)
    const now = ctx.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(0.1, now + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
    
    // Play the sound
    oscillator.start(now);
    oscillator.stop(now + 0.1);
}

// Generate strumming sound
function playStrummingSound(strumType) {
    const ctx = initializeAudio();
    
    if (strumType === '-') return; // No sound for rest
    
    // Create noise for guitar-like sound
    const bufferSize = ctx.sampleRate * 0.1; // 100ms of audio
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    
    // Generate filtered noise for strum sound
    for (let i = 0; i < bufferSize; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.3));
    }
    
    const source = ctx.createBufferSource();
    const filter = ctx.createBiquadFilter();
    const gainNode = ctx.createGain();
    
    source.buffer = buffer;
    
    // Set filter based on strum type
    filter.type = 'bandpass';
    filter.frequency.value = strumType === 'D' ? 200 : 400; // Down strum lower, up strum higher
    filter.Q.value = 5;
    
    // Set volume based on strum type
    gainNode.gain.value = strumType === 'X' ? 4.0 : 6.0; // Muted strum quieter
    
    // Connect nodes
    source.connect(filter);
    filter.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    // Play the sound
    source.start();
}

// Metronome functions
function startMetronome() {
    // No-op: main metronome removed
}

function stopMetronome() {
    // No-op: main metronome removed
}

// Chord variant change function
function changeChordVariant(selectElement) {
    const variant = selectElement.value;
    const chordCard = selectElement.closest('.chord-card-modern');
    const chordName = chordCard.getAttribute('data-chord-name');
    const diagramContainer = chordCard.querySelector('.chord-diagram');
    
    // Update chord diagram
    updateChordDiagram(chordName, variant, diagramContainer);
    
    // Save selected variant
    saveSelectedVariant(chordName, variant);
}

// Function to render the strumming pattern as SVG
function renderStrummingPattern(containerId = 'floating-strumming-pattern-display', isMainDisplay = false) {
    const container = document.getElementById(containerId);
    if (!container) {
        return;
    }

    // Use the global rawStrummingData parsed from song.strumming_pattern
    // let rawStrummingData = ...; // REMOVE this line
    const timeSignature = "{{ song.time_signature }}"; // Get time signature
    let displayBeats = null;
    {% if song.display_beats is defined and song.display_beats %}
        displayBeats = {{ song.display_beats }};
    {% endif %}
    const tsParts = timeSignature.split('/');
    const beatsInBar = parseInt(tsParts[0]) || 4;
    if (!displayBeats || displayBeats <= 0) {
        displayBeats = beatsInBar;
    }
    
    // Handle different data formats
    let strummingPatternData;
    let beatSubdivisions;
    
    // Always use the subdivisions array from the pattern data if present
    if (typeof rawStrummingData === 'object' && rawStrummingData !== null && 'pattern' in rawStrummingData) {
        strummingPatternData = rawStrummingData.pattern;
        if (Array.isArray(rawStrummingData.subdivisions) && rawStrummingData.subdivisions.length > 0) {
            // Ensure the subdivisions array matches the number of beats to display
            let needed = displayBeats;
            let arr = rawStrummingData.subdivisions;
            if (arr.length === needed) {
                beatSubdivisions = arr;
            } else if (arr.length < needed) {
                // Repeat the array to fill needed beats
                beatSubdivisions = Array.from({length: needed}, (_, i) => arr[i % arr.length]);
            } else {
                // Truncate if too long
                beatSubdivisions = arr.slice(0, needed);
            }
        } else {
            // Fallback: use time signature numerator for beats, 4 subdivisions per beat
            const tsParts = timeSignature.split('/');
            const beats = parseInt(tsParts[0]) || 4;
            beatSubdivisions = Array(beats).fill(4);
        }
    } else if (Array.isArray(rawStrummingData)) {
        strummingPatternData = rawStrummingData;
        // Fallback: use time signature numerator for beats, 4 subdivisions per beat
        const tsParts = timeSignature.split('/');
        const beats = parseInt(tsParts[0]) || 4;
        beatSubdivisions = Array(beats).fill(4);
    } else {
        strummingPatternData = [];
        beatSubdivisions = [4,4,4,4];
    }

    // Calculate the total number of slots (subdivisions) in the pattern
    const totalSlots = strummingPatternData.length;
    // Calculate the total number of beats in the pattern based on subdivisions
    let numberOfBeats = 0;
    let slotCount = 0;
    while (slotCount < strummingPatternData.length && numberOfBeats < displayBeats) {
        for (let b = 0; b < beatSubdivisions.length && slotCount < strummingPatternData.length && numberOfBeats < displayBeats; b++) {
            numberOfBeats++;
            slotCount += beatSubdivisions[b];
        }
    }
    // Only render up to displayBeats beats
    const beatsToShow = Math.min(numberOfBeats, displayBeats);
    // Now numberOfBeats is the actual number of beats in the pattern

    if (!Array.isArray(strummingPatternData) || strummingPatternData.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-2">No strumming pattern available</p>';
        return;
    }

    // Determine how many beats per line (always 4 for readability)
    const beatsPerLine = beatsInBar; // Always 1 measure per line
    const totalLines = Math.ceil(beatsToShow / beatsPerLine);
    
    // SVG dimensions per line - different for main vs floating display
    const svgWidth = isMainDisplay ? (container.offsetWidth || 600) : 280;
    const svgHeight = isMainDisplay ? 120 : 100;
    const margin = isMainDisplay ? 
        { top: 20, right: 20, bottom: 20, left: 40 } : 
        { top: 15, right: 15, bottom: 15, left: 30 };
    
    // Clear container
    container.innerHTML = '';
    
    // Create multiple SVGs, one for each line
    let globalSlotIndex = 0;
    for (let lineIndex = 0; lineIndex < totalLines; lineIndex++) {
        const startBeat = lineIndex * beatsPerLine;
        const endBeat = Math.min(startBeat + beatsPerLine, beatsToShow);
        
        // Calculate total slots for this line
        let totalSlotsInLine = 0;
        let beatIndicesInLine = [];
        let tempSlotIndex = globalSlotIndex;
        for (let beat = startBeat; beat < endBeat; beat++) {
            const beatIndex = beat % beatSubdivisions.length;
            const subdivisions = beatSubdivisions[beatIndex] || 2;
            totalSlotsInLine += subdivisions;
            beatIndicesInLine.push(beatIndex);
        }
        
        const plotWidth = svgWidth - margin.left - margin.right;
        const plotHeight = svgHeight - margin.top - margin.bottom;
        const slotWidth = plotWidth / totalSlotsInLine;
        
        // Create SVG for this line
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', svgWidth);
    svg.setAttribute('height', svgHeight);
        svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
        
        if (isMainDisplay) {
            svg.style.background = '#f8f9fa';
            svg.style.border = '1px solid #dee2e6';
            svg.style.borderRadius = '8px';
            svg.style.marginBottom = '10px';
        } else {
            svg.style.background = 'var(--bg-gray-50)';
            svg.style.border = '1px solid var(--border-color)';
            svg.style.borderRadius = 'var(--radius-sm)';
            svg.style.marginBottom = '8px';
        }
        
        let currentSlotInLine = 0;
        // Draw beats for this line
        for (let beat = startBeat; beat < endBeat; beat++) {
            const beatIndex = beat % beatSubdivisions.length;
            const subdivisions = beatSubdivisions[beatIndex] || 2;
            const beatStartX = margin.left + currentSlotInLine * slotWidth;
            const beatEndX = margin.left + (currentSlotInLine + subdivisions) * slotWidth;
            const beatCenterX = (beatStartX + beatEndX) / 2;
            
            // Draw beat number (restart at 1 for each line)
            const beatLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            beatLabel.setAttribute('x', beatCenterX);
            beatLabel.setAttribute('y', isMainDisplay ? margin.top - 10 : margin.top - 5);
            beatLabel.setAttribute('text-anchor', 'middle');
            beatLabel.setAttribute('font-size', isMainDisplay ? '12' : '10');
            beatLabel.setAttribute('font-weight', 'bold');
            beatLabel.setAttribute('fill', '#212529');
            beatLabel.textContent = (beat - startBeat) + 1;
            svg.appendChild(beatLabel);

            // Draw bracket for every beat
            const bracketY = (isMainDisplay ? margin.top - 25 : margin.top - 18);
            const bracketStartX = beatStartX + 2;
            const bracketEndX = beatEndX - 2;
                const bracketMidX = (bracketStartX + bracketEndX) / 2;
                const bracketPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                bracketPath.setAttribute('d', `M ${bracketStartX} ${bracketY} L ${bracketStartX} ${bracketY - 5} L ${bracketEndX} ${bracketY - 5} L ${bracketEndX} ${bracketY}`);
            bracketPath.setAttribute('stroke', '#888');
                bracketPath.setAttribute('stroke-width', '1.5');
                bracketPath.setAttribute('fill', 'none');
                svg.appendChild(bracketPath);
            // Draw subdivision count in the middle of the bracket
            const subCountText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            subCountText.setAttribute('x', bracketMidX);
            subCountText.setAttribute('y', bracketY - 8);
            subCountText.setAttribute('text-anchor', 'middle');
            subCountText.setAttribute('font-size', isMainDisplay ? '12' : '10');
            subCountText.setAttribute('fill', '#888');
            subCountText.setAttribute('font-weight', 'bold');
            subCountText.textContent = subdivisions;
            svg.appendChild(subCountText);
            
            // Draw subdivision markers
            for (let sub = 0; sub < subdivisions; sub++) {
                if (globalSlotIndex >= strummingPatternData.length) break;
                
                const x = margin.left + (currentSlotInLine + sub + 0.5) * slotWidth;
                const y = margin.top + plotHeight / 2;
                
                const strum = strummingPatternData[globalSlotIndex];
                let symbol = '';
                let color = '#6c757d';
                
                switch (strum) {
                    case 'D':
                        symbol = '';
                        color = '#28a745';
                        break;
                    case 'U':
                        symbol = '';
                        color = '#17a2b8';
                        break;
                    case 'X':
                        symbol = 'X';
                        color = '#dc3545';
                        break;
                    case '-':
                    default:
                        symbol = '-';
                        color = '#6c757d';
                        break;
                }
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', isMainDisplay ? y + 5 : y + 3);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', isMainDisplay ? '18' : '14');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', color);
                text.textContent = symbol;
                text.setAttribute('data-strum-index', globalSlotIndex); // For animation
                svg.appendChild(text);
                
                // Draw subdivision separator only if more than one subdivision in this beat
                if (subdivisions > 1 && sub < subdivisions - 1) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', margin.left + (currentSlotInLine + sub + 1) * slotWidth);
                    line.setAttribute('y1', isMainDisplay ? margin.top + 10 : margin.top + 8);
                    line.setAttribute('x2', margin.left + (currentSlotInLine + sub + 1) * slotWidth);
                    line.setAttribute('y2', isMainDisplay ? margin.top + plotHeight - 10 : margin.top + plotHeight - 8);
                    line.setAttribute('stroke', '#dee2e6');
                    line.setAttribute('stroke-width', '1');
                    svg.appendChild(line);
                }
                
                globalSlotIndex++;
            }
            
            // Draw beat separator (heavier line)
            // Only draw a thick separator if this is not the last beat of the measure, line, or pattern
            const isLastBeatOfMeasure = ((beat + 1) % beatsPerLine === 0);
            const isLastBeatInLine = (beat === endBeat - 1);
            const isLastBeatInPattern = (beat === beatsToShow - 1);
            if (!isLastBeatOfMeasure && !isLastBeatInLine && !isLastBeatInPattern) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', beatEndX);
                line.setAttribute('y1', margin.top);
                line.setAttribute('x2', beatEndX);
                line.setAttribute('y2', margin.top + plotHeight);
                line.setAttribute('stroke', '#495057');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);
            }
            
            currentSlotInLine += subdivisions;
        }
        
        // Add this line's SVG to the container
    container.appendChild(svg);
    }
}

function updateChordDiagram(chordName, variant, container) {
    const encodedChordName = encodeURIComponent(chordName);
    const variantParam = variant ? `?variant=${encodeURIComponent(variant)}` : '';
    const newUrl = `/chord/${encodedChordName}${variantParam}`;
    
    // Create a new object element to load the new SVG
    const newObject = document.createElement('object');
    newObject.data = newUrl;
    newObject.type = 'image/svg+xml';
    newObject.className = 'chord-diagram';
    newObject.textContent = `${chordName} diagram`;
    
    // Replace the existing diagram
    container.innerHTML = '';
    container.appendChild(newObject);
}

// Function to save selected variant
function saveSelectedVariant(chordName, variant) {
    fetch(`/song/{{ song.id }}/save_variant`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            chord_name: chordName,
            variant: variant
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Failed to save variant');
        }
    })
    .catch(error => {
        console.error('Error saving variant:', error);
    });
}

// Enhanced Chord Progression Functions
function toggleProgessionView(view) {
    // Update button states
    document.querySelectorAll('.btn-group-modern button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view-${view}-btn`).classList.add('active');
    
    // Hide all views
    document.querySelectorAll('.chord-progression-view').forEach(viewEl => viewEl.style.display = 'none');
    
    // Show selected view
    document.getElementById(`chord-progression-${view}`).style.display = 'block';
    
    currentProgressionView = view;
    
    // Initialize the view if needed
    if (view === 'formatted') {
        updateFormattedView();
    }
}

// Parse chord progression from text
function parseChordProgression(text) {
    const lines = text.split('\n');
    const parsedLines = [];
    let currentSection = null;
    lines.forEach(line => {
        const trimmedLine = line.trim();
        if (trimmedLine.length === 0) return;
        // Detect section header
        if (trimmedLine.startsWith('#')) {
            currentSection = trimmedLine.replace(/^#+\s*/, '');
            parsedLines.push({ type: 'section', label: currentSection });
            return;
        }
        // Split by spaces but keep | | notation intact
        const parts = trimmedLine.split(/\s+/);
        const chords = [];
        let inHalfMeasure = false;
        let currentHalfMeasure = [];
        parts.forEach(part => {
            if (part === '|') {
                if (inHalfMeasure) {
                    chords.push({ type: 'half-measure', chords: currentHalfMeasure });
                    currentHalfMeasure = [];
                    inHalfMeasure = false;
                } else {
                    inHalfMeasure = true;
                }
            } else if (/^[A-G][#b]?([a-zA-Z0-9()+\/-]*)$/.test(part)) {
                // This is a chord (robust regex)
                if (inHalfMeasure) {
                    currentHalfMeasure.push({ chord: part, original: part });
                } else {
                    chords.push({ type: 'chord', chord: part, original: part });
                }
            }
        });
        // Handle case where half measure wasn't closed
        if (inHalfMeasure && currentHalfMeasure.length > 0) {
            chords.push({ type: 'half-measure', chords: currentHalfMeasure });
        }
        // Always push a chord-line if any chords found
        if (chords.length > 0) {
            parsedLines.push({ type: 'chord-line', chords });
        }
    });
    return parsedLines;
}

function updateFormattedView() {
    const container = document.getElementById('formatted-progression');
    const showBarNumbers = document.getElementById('show-bar-numbers').checked;
    container.innerHTML = '';
    const chordProgressionData = `{{ song.chord_progression }}`;
    const parsedLines = parseChordProgression(chordProgressionData);
    if (parsedLines.length === 0) {
        container.innerHTML = '<p class="text-muted">No chords found in progression</p>';
        return;
    }
    let barNumber = 1;
    parsedLines.forEach(lineObj => {
        if (lineObj.type === 'section') {
            // Add section header
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'progression-section-header';
            sectionDiv.textContent = lineObj.label;
            container.appendChild(sectionDiv);
        } else if (lineObj.type === 'chord-line') {
            // Create bar container
            const barContainer = document.createElement('div');
            barContainer.className = 'bar-container mb-4';
            // Create chord boxes container
            const chordBoxesContainer = document.createElement('div');
            chordBoxesContainer.className = 'chord-boxes-container';
            if (showBarNumbers) {
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label-inline';
                barLabel.textContent = `Line ${barNumber}`;
                chordBoxesContainer.appendChild(barLabel);
            }
            lineObj.chords.forEach((item, index) => {
                if (item.type === 'half-measure') {
                    // Create half measure group
                    const halfMeasureGroup = document.createElement('div');
                    halfMeasureGroup.className = 'half-measure-group';
                    item.chords.forEach((chordObj, chordIndex) => {
                        const chordBox = document.createElement('div');
                        chordBox.className = 'chord-box half-measure-chord';
                        chordBox.textContent = chordObj.chord;
                        chordBox.setAttribute('data-chord', chordObj.chord);
                        if (document.getElementById('highlight-on-click').checked) {
                            chordBox.addEventListener('click', function() {
                                highlightChord(this.getAttribute('data-chord'));
                            });
                        }
                        halfMeasureGroup.appendChild(chordBox);
                    });
                    chordBoxesContainer.appendChild(halfMeasureGroup);
                } else if (item.type === 'chord') {
                    // Create regular chord box
                    const chordBox = document.createElement('div');
                    chordBox.className = 'chord-box';
                    chordBox.textContent = item.chord;
                    chordBox.setAttribute('data-chord', item.chord);
                    if (document.getElementById('highlight-on-click').checked) {
                        chordBox.addEventListener('click', function() {
                            highlightChord(this.getAttribute('data-chord'));
                        });
                    }
                    chordBoxesContainer.appendChild(chordBox);
                }
            });
            barContainer.appendChild(chordBoxesContainer);
            container.appendChild(barContainer);
            barNumber++;
        }
    });
}

function highlightChord(chordName) {
    // Remove existing highlights
    document.querySelectorAll('.progression-chord.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });
    
    // Highlight matching chords
    document.querySelectorAll(`[data-chord="${chordName}"]`).forEach(el => {
        el.classList.add('highlighted');
    });
    
    // Also highlight chord diagram if visible
    const chordCard = document.querySelector(`[data-chord-name="${chordName}"]`);
    if (chordCard) {
        document.querySelectorAll('.chord-card-modern.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });
        chordCard.classList.add('highlighted');
    }
}

// Strumming pattern playback
let isStrummingPlaying = false;
let strummingInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Render the strumming pattern SVG on page load for both displays
    renderStrummingPattern('main-strumming-pattern-display', true); // Main display
    renderStrummingPattern('floating-strumming-pattern-display', false); // Floating display

    // Assign the strumming pattern data to the global variable after DOM is loaded
    let rawStrummingData = {{ song.strumming_pattern_list | tojson }};
    
    // Handle different data formats for playback
    if (typeof rawStrummingData === 'object' && rawStrummingData !== null && 'pattern' in rawStrummingData) {
        // New triplet format: extract the pattern array
        strummingPatternData = rawStrummingData.pattern;
    } else if (Array.isArray(rawStrummingData)) {
        // Legacy format: use directly
        strummingPatternData = rawStrummingData;
    } else {
        // Invalid format
        strummingPatternData = [];
    }
    
    // Initialize chord progression with formatted view as default
    currentProgressionView = 'formatted';
    updateFormattedView();
});

// Initialize metronome dots when page loads
document.addEventListener('DOMContentLoaded', function() {
    renderStrummingPattern();
    updateFormattedView();
});

// Global variables for floating controls
let currentBPM = {{ song.bpm }};
const originalBPM = {{ song.bpm }};
let isFloatingMetronomeActive = false;
let isFloatingStrummingActive = false;

// Floating controls toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggle-floating-controls');
    const floatingControls = document.getElementById('floating-audio-controls');
    const toggleIcon = toggleBtn.querySelector('i');
    
    // Header click to toggle
    document.querySelector('.floating-controls-header').addEventListener('click', function(e) {
        if (e.target.closest('#toggle-floating-controls')) return;
        toggleFloatingControls();
    });
    
    // Toggle button click
    toggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleFloatingControls();
    });
    
    function toggleFloatingControls() {
        floatingControls.classList.toggle('minimized');
        const isMinimized = floatingControls.classList.contains('minimized');
        toggleIcon.className = isMinimized ? 'fas fa-plus' : 'fas fa-minus';
    }
    
    // Initialize floating metronome dots
    updateFloatingMetronomeDots();
});

// Tempo adjustment functions
function adjustTempo(change) {
    const newBPM = Math.max(20, Math.min(300, currentBPM + change));
    if (newBPM !== currentBPM) {
        currentBPM = newBPM;
        updateBPMDisplay();
        
        // Update metronome if it's running
        if (isMetronomePlaying || isFloatingMetronomeActive) {
            stopMetronome();
            stopFloatingMetronome();
            setTimeout(() => {
                if (isFloatingMetronomeActive) {
                    startFloatingMetronome();
                } else {
                    startMetronome();
                }
            }, 100);
        }
    }
}

function resetTempo() {
    if (currentBPM !== originalBPM) {
        currentBPM = originalBPM;
        updateBPMDisplay();
        
        // Update metronome if it's running
        if (isMetronomePlaying || isFloatingMetronomeActive) {
            stopMetronome();
            stopFloatingMetronome();
            setTimeout(() => {
                if (isFloatingMetronomeActive) {
                    startFloatingMetronome();
                } else {
                    startMetronome();
                }
            }, 100);
        }
    }
}

function updateBPMDisplay() {
    document.getElementById('current-bpm').textContent = currentBPM;
}

// Floating metronome functions
function updateFloatingMetronomeDots() {
    const timeSignature = "{{ song.time_signature }}";
    const beatsPerMeasure = parseInt(timeSignature.split('/')[0]) || 4;
    const dotsContainer = document.getElementById('floating-metronome-dots');
    
    dotsContainer.innerHTML = '';
    for (let i = 0; i < beatsPerMeasure; i++) {
        const dot = document.createElement('span');
        dot.className = 'metronome-dot';
        dotsContainer.appendChild(dot);
    }
}

function toggleMetronome() {
    if (isFloatingMetronomeActive) {
        stopFloatingMetronome();
    } else {
        // Stop any existing metronome
        stopMetronome();
        startFloatingMetronome();
    }
}

function startFloatingMetronome() {
    if (isFloatingMetronomeActive) return;
    
    initializeAudio();
    
    isFloatingMetronomeActive = true;
    const timeSignature = "{{ song.time_signature }}";
    const beatsPerMeasure = parseInt(timeSignature.split('/')[0]) || 4;
    const interval = 60000 / currentBPM;
    
    let beatCount = 0;
    const dots = document.querySelectorAll('#floating-metronome-dots .metronome-dot');
    
    // Update button state
    const btn = document.getElementById('floating-metronome-btn');
    const status = document.getElementById('metronome-status');
    btn.classList.add('active');
    status.textContent = 'Stop Metronome';
    
    function beat() {
        if (!isFloatingMetronomeActive) return;
        
        // Play metronome click
        playMetronomeClick(beatCount === 0);
        
        // Update dots
        dots.forEach(dot => dot.classList.remove('active'));
        if (dots[beatCount]) {
            dots[beatCount].classList.add('active');
        }
        
        beatCount = (beatCount + 1) % beatsPerMeasure;
        floatingMetronomeInterval = setTimeout(beat, interval);
    }
    
    beat();
}

function stopFloatingMetronome() {
    isFloatingMetronomeActive = false;
    clearTimeout(floatingMetronomeInterval);
    
    // Update button state
    const btn = document.getElementById('floating-metronome-btn');
    const status = document.getElementById('metronome-status');
    btn.classList.remove('active');
    status.textContent = 'Start Metronome';
    
    // Clear dots
    document.querySelectorAll('#floating-metronome-dots .metronome-dot').forEach(dot => {
        dot.classList.remove('active');
    });
}

// Floating strumming pattern functions
function toggleStrummingPattern() {
    if (isFloatingStrummingActive) {
        stopFloatingStrummingPattern();
    } else {
        startFloatingStrummingPattern();
    }
}

function startFloatingStrummingPattern() {
    if (isFloatingStrummingActive || !strummingPatternData.length) return;
    
    initializeAudio();
    isFloatingStrummingActive = true;
    
    // Update button state
    const btn = document.getElementById('floating-strumming-btn');
    const status = document.getElementById('strumming-status');
    btn.classList.add('active');
    status.textContent = 'Stop Pattern';
    
    // Start strumming pattern playback
    const bpm = currentBPM;
    const timeSignature = "{{ song.time_signature }}";
    
    // Calculate interval based on time signature and subdivision
    const beatInterval = 60000 / bpm;
    
    // Determine subdivisions per beat based on time signature
    const timeSignatureParts = timeSignature.split('/');
    let subdivisionsPerBeat = 2; // Default
    
    if (timeSignatureParts.length === 2 && parseInt(timeSignatureParts[1]) === 3) {
        // For time signatures with denominator 3 (like 4/3), each beat has 3 subdivisions
        subdivisionsPerBeat = 3;
    } else if (timeSignature === '4/4') {
        // For 4/4 time signature, use 4 subdivisions per beat (16th notes)
        subdivisionsPerBeat = 4;
    }
    
    const subdivisionInterval = beatInterval / subdivisionsPerBeat;
    
    let patternIndex = 0;
    
    function playNextStrum() {
        if (!isFloatingStrummingActive) return;
        
        if (patternIndex >= strummingPatternData.length) {
            patternIndex = 0; // Loop the pattern
        }
        
        // Play the actual strum sound
        const strumType = strummingPatternData[patternIndex];
        playStrummingSound(strumType);
        pulseStrumArrow(patternIndex);
        
        patternIndex++;
        floatingStrummingInterval = setTimeout(playNextStrum, subdivisionInterval);
    }
    
    playNextStrum();
}

function stopFloatingStrummingPattern() {
    isFloatingStrummingActive = false;
    clearTimeout(floatingStrummingInterval);
    
    // Update button state
    const btn = document.getElementById('floating-strumming-btn');
    const status = document.getElementById('strumming-status');
    btn.classList.remove('active');
    status.textContent = 'Play Pattern';
}

function checkStrummingPatternStatus() {
    // This function is no longer needed since we handle playback directly
    return;
}

// Override original metronome functions to sync with floating controls
const originalStartMetronome = startMetronome;
const originalStopMetronome = stopMetronome;

startMetronome = function() {
    stopFloatingMetronome(); // Stop floating if active
    originalStartMetronome();
};

stopMetronome = function() {
    originalStopMetronome();
    // Don't automatically start floating - let user control it
};

// Variables for intervals
let floatingMetronomeInterval;
let floatingStrummingInterval;

function pulseStrumArrow(strumIndex) {
    // Remove pulse from all arrows in both displays
    document.querySelectorAll('#main-strumming-pattern-display [data-strum-index], #floating-strumming-pattern-display [data-strum-index]').forEach(el => {
        el.classList.remove('pulse-arrow');
    });
    // Pulse in main display
    const mainArrow = document.querySelector(`#main-strumming-pattern-display [data-strum-index='${strumIndex}']`);
    if (mainArrow) {
        void mainArrow.offsetWidth;
        mainArrow.classList.add('pulse-arrow');
    }
    // Pulse in floating display
    const floatArrow = document.querySelector(`#floating-strumming-pattern-display [data-strum-index='${strumIndex}']`);
    if (floatArrow) {
        void floatArrow.offsetWidth;
        floatArrow.classList.add('pulse-arrow');
    }
}

// Parse the raw strumming pattern JSON (with subdivisions) from the backend
let rawStrummingData = null;
try {
    rawStrummingData = JSON.parse({{ song.strumming_pattern | tojson | safe }});
} catch (e) {
    rawStrummingData = null;
}

// --- Practice Mode Logic (updated) ---
let practiceModeActive = false;
let practiceChordList = [];
let practiceChordIndex = 0;
let practiceTimeout = null;
let practiceCountdownInterval = null;
let beatsInPattern = 4; // default, will be set dynamically

function getBeatsInStrummingPattern() {
  // Try to get from strumming pattern subdivisions or time signature
  if (typeof rawStrummingData === 'object' && rawStrummingData !== null && 'subdivisions' in rawStrummingData) {
    return Array.isArray(rawStrummingData.subdivisions) ? rawStrummingData.subdivisions.length : 4;
  }
  // fallback: use time signature numerator
  const ts = "{{ song.time_signature }}";
  const parts = ts.split('/');
  return parseInt(parts[0]) || 4;
}

function addPracticeModeButton() {
  const cardHeader = document.querySelector('.card-header-modern .card-title-modern i.fa-music').parentElement.parentElement;
  if (!document.getElementById('practice-mode-btn')) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-primary-modern ms-3';
    btn.id = 'practice-mode-btn';
    btn.innerHTML = '<i class="fas fa-running me-2"></i>Practice Mode';
    btn.onclick = openPracticeModeModal;
    cardHeader.appendChild(btn);
  }
}
document.addEventListener('DOMContentLoaded', addPracticeModeButton);

function openPracticeModeModal() {
  const modal = new bootstrap.Modal(document.getElementById('practiceModeModal'));
  document.getElementById('practice-countdown').textContent = '3';
  document.getElementById('practice-instructions').textContent = 'Get ready...';
  modal.show();
  startPracticeCountdown(modal);
}

function startPracticeCountdown(modal) {
  let count = 3;
  document.getElementById('practice-countdown').textContent = count;
  document.getElementById('practice-instructions').textContent = 'Get ready...';
  practiceModeActive = false;
  clearTimeout(practiceTimeout);
  clearInterval(practiceCountdownInterval);
  practiceCountdownInterval = setInterval(() => {
    if (count > 0) {
      document.getElementById('practice-countdown').textContent = count;
      playMetronomeClick(false); // Play beep for each count
    } else if (count === 0) {
      document.getElementById('practice-countdown').textContent = 'Go!';
      document.getElementById('practice-instructions').textContent = '';
      playMetronomeClick(true); // Higher beep for Go!
    } else {
      clearInterval(practiceCountdownInterval);
      document.getElementById('practice-countdown').textContent = '';
      // Hide modal after countdown
      bootstrap.Modal.getInstance(document.getElementById('practiceModeModal')).hide();
      startPracticeMode();
    }
    count--;
  }, 1000);
}

let practiceShouldStartMetronome = true;
document.addEventListener('DOMContentLoaded', function() {
  const metCheck = document.getElementById('practice-start-metronome');
  if (metCheck) {
    metCheck.addEventListener('change', function() {
      practiceShouldStartMetronome = this.checked;
    });
    practiceShouldStartMetronome = metCheck.checked;
  }
});

function startPracticeMode() {
  practiceModeActive = true;
  document.getElementById('practiceModeIndicator').style.display = 'block';
  // Optionally start metronome
  if (practiceShouldStartMetronome) {
    if (!isFloatingMetronomeActive) startFloatingMetronome();
  }
  // Parse chords from formatted progression
  practiceChordList = getPracticeChordListWithSplits();
  practiceChordIndex = 0;
  highlightPracticeChord(-1); // Clear any highlights
  advancePracticeChord();
  // Stop button in floating indicator
  document.getElementById('stopPracticeFloatingBtn').onclick = stopPracticeMode;
  // Also handle modal stop button (if user opens modal again)
  document.getElementById('stopPracticeBtn').onclick = function() {
    bootstrap.Modal.getInstance(document.getElementById('practiceModeModal')).hide();
    stopPracticeMode();
  };
  // Do NOT stop practice mode on modal hidden event anymore
}

function stopPracticeMode() {
  practiceModeActive = false;
  clearTimeout(practiceTimeout);
  clearInterval(practiceCountdownInterval);
  highlightPracticeChord(-1); // Clear highlights
  document.getElementById('practiceModeIndicator').style.display = 'none';
  // Optionally stop metronome
  if (practiceShouldStartMetronome && isFloatingMetronomeActive) {
    stopFloatingMetronome();
  }
}

function getPracticeChordListWithSplits() {
  // Determine the full strumming pattern length in beats
  let totalBeatsInPattern = 0;
  if (typeof rawStrummingData === 'object' && rawStrummingData !== null && 'subdivisions' in rawStrummingData) {
    totalBeatsInPattern = Array.isArray(rawStrummingData.subdivisions) ? rawStrummingData.subdivisions.length : 4;
    } else {
    // fallback: use time signature numerator
    const ts = "{{ song.time_signature }}";
    const tsParts = ts.split('/');
    totalBeatsInPattern = parseInt(tsParts[0]) || 4;
  }
  const displayBeats = {{ song.display_beats if song.display_beats is defined else 'null' }};
  if (displayBeats && displayBeats > 0) {
    totalBeatsInPattern = displayBeats;
  }

  // Collect chords in correct visual order (left to right, including half-measure in place)
  const chords = [];
  const barContainers = Array.from(document.querySelectorAll('#formatted-progression .bar-container'));
  barContainers.forEach(bar => {
    // Get all direct children of the chord-boxes-container (could be .chord-box or .half-measure-group)
    const chordBoxesContainer = bar.querySelector('.chord-boxes-container');
    if (!chordBoxesContainer) return;
    Array.from(chordBoxesContainer.children).forEach(child => {
      if (child.classList.contains('chord-box')) {
        chords.push({
          el: child,
          chord: child.textContent.trim(),
          beats: totalBeatsInPattern
        });
      } else if (child.classList.contains('half-measure-group')) {
        // Add each half-measure chord in order
        Array.from(child.querySelectorAll('.half-measure-chord')).forEach(box => {
          chords.push({
            el: box,
            chord: box.textContent.trim(),
            beats: totalBeatsInPattern / 2
          });
        });
      }
    });
  });
  return chords;
}

function advancePracticeChord() {
  if (!practiceModeActive || practiceChordIndex >= practiceChordList.length) {
    stopPracticeMode();
    return;
  }
  // Highlight current chord
  highlightPracticeChord(practiceChordIndex);
  // Calculate duration
  const bpm = currentBPM;
  const msPerBeat = 60000 / bpm;
  const beats = practiceChordList[practiceChordIndex].beats;
  const duration = msPerBeat * beats;
  practiceChordIndex++;
  practiceTimeout = setTimeout(advancePracticeChord, duration);
}

function highlightPracticeChord(idx) {
  // Remove highlight from all
  document.querySelectorAll('#formatted-progression .chord-box, #formatted-progression .half-measure-chord').forEach(el => {
    el.classList.remove('highlighted');
  });
  if (idx >= 0 && idx < practiceChordList.length) {
    practiceChordList[idx].el.classList.add('highlighted');
    // Scroll into view if needed
    practiceChordList[idx].el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
  }
}
</script>

<!-- Add Practice Mode Modal -->
<div class="modal fade" id="practiceModeModal" tabindex="-1" aria-labelledby="practiceModeLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="practiceModeLabel">Practice Mode</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="practice-countdown" style="font-size:2.5rem; font-weight:bold; margin-bottom:1rem;">3</div>
        <div id="practice-instructions">Get ready...</div>
        <div class="form-check mt-3 mb-2" style="display:flex;align-items:center;justify-content:center;gap:0.5em;">
          <input class="form-check-input" type="checkbox" id="practice-start-metronome" checked>
          <label class="form-check-label" for="practice-start-metronome">Start metronome with practice</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="stopPracticeBtn">Stop Practice</button>
      </div>
    </div>
  </div>
</div>

<!-- Floating Practice Mode Indicator -->
<div id="practiceModeIndicator" style="display:none; position:fixed; top:20px; right:20px; z-index:2000; background:#d32f2f; color:white; padding:0.75rem 1.5rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.12); font-weight:600; font-size:1rem;">
  Practice Mode
  <button id="stopPracticeFloatingBtn" style="background:rgba(255,255,255,0.15); color:white; border:none; border-radius:6px; margin-left:1rem; padding:0.25rem 0.75rem; font-size:0.95em; cursor:pointer;">Stop</button>
</div>
{% endblock %}