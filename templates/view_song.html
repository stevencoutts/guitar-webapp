{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h2 class="card-title mb-1 text-primary">{{ song.title }}</h2>
                        <h5 class="text-muted mb-0">{{ song.artist or 'No artist specified' }}</h5>
                    </div>
                    <div class="metronome-container text-end">
                        <button id="startMetronome" class="btn btn-primary mb-2">Start Metronome</button>
                        <div class="metronome-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="text-primary">Time Signature: {{ song.time_signature }}</h5>
                        <h5 class="text-primary">BPM: {{ song.bpm }}</h5>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="text-primary">Chord Progression:</h5>
                        <pre class="chord-progression text-start">{{ song.chord_progression }}</pre>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="text-primary">Strumming Pattern:</h5>
                        <pre class="strumming-pattern">{{ song.strumming_pattern }}</pre>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('edit_song', song_id=song.id) }}" class="btn btn-primary">Edit Song</a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Back to Songs</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chord-progression, .strumming-pattern {
    white-space: pre-wrap;
    font-family: monospace;
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    margin: 0;
    text-align: left;
    border: 1px solid #e9ecef;
}

.metronome-dots {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background-color: #e9ecef;
    transition: background-color 0.1s ease;
}

.dot.active {
    background-color: #0d6efd;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.dot.active {
    animation: pulse 0.1s ease;
}

.card {
    border-color: #0d6efd;
    box-shadow: 0 0.125rem 0.25rem rgba(13, 110, 253, 0.075);
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.btn-outline-primary {
    color: #0d6efd;
    border-color: #0d6efd;
}

.btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.text-primary {
    color: #0d6efd !important;
}
</style>

<script>
let audioContext = null;
let metronomeInterval;
let isPlaying = false;
const bpm = {{ song.bpm }};
const timeSignature = "{{ song.time_signature }}";
const [beats, _] = timeSignature.split('/').map(Number);
let currentBeat = 0;

function createAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioContext;
}

function playClick() {
    const context = createAudioContext();
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    oscillator.frequency.value = 1000;
    gainNode.gain.value = 0.1;

    oscillator.start(context.currentTime);
    oscillator.stop(context.currentTime + 0.1);
}

function updateMetronomeDots() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, index) => {
        if (index === currentBeat) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
    currentBeat = (currentBeat + 1) % beats;
}

function startMetronome() {
    if (!isPlaying) {
        isPlaying = true;
        const interval = (60 / bpm) * 1000;
        
        createAudioContext(); // Initialize audio context on user interaction
        
        // Play first click immediately and update dots
        playClick();
        updateMetronomeDots();
        
        // Start the interval for subsequent clicks
        metronomeInterval = setInterval(() => {
            playClick();
            updateMetronomeDots();
        }, interval);
        
        document.getElementById('startMetronome').textContent = 'Stop Metronome';
    } else {
        stopMetronome();
    }
}

function stopMetronome() {
    isPlaying = false;
    clearInterval(metronomeInterval);
    document.getElementById('startMetronome').textContent = 'Start Metronome';
    currentBeat = 0;
    updateMetronomeDots();
}

document.getElementById('startMetronome').addEventListener('click', startMetronome);

// Cleanup when leaving the page
window.addEventListener('beforeunload', function() {
    if (metronomeInterval) {
        clearInterval(metronomeInterval);
    }
});
</script>
{% endblock %} 