{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <h2 class="card-title mb-0 text-primary">
                        <i class="fas fa-music me-2"></i>{{ song.title }}
                    </h2>
                    <div class="metronome-container text-end">
                        <button id="startMetronome" class="btn btn-primary mb-2">
                            <i class="fas fa-play me-2"></i>Start Metronome
                        </button>
                        <div class="metronome-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="text-primary">
                            <i class="fas fa-clock me-2"></i>Time Signature: {{ song.time_signature }}
                        </h5>
                        <h5 class="text-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>BPM: {{ song.bpm }}
                        </h5>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="text-primary">
                            <i class="fas fa-guitar me-2"></i>Chord Progression:
                        </h5>
                        <pre class="pre-formatted">{{ song.chord_progression }}</pre>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="text-primary">
                            <i class="fas fa-hand-paper me-2"></i>Strumming Pattern:
                        </h5>
                        <pre class="pre-formatted">{{ song.strumming_pattern }}</pre>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('edit_song', song_id=song.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit Song
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Songs
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.metronome-dots {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background-color: var(--border-color);
    transition: all 0.3s ease;
}

.dot.active {
    background-color: var(--primary-color);
    transform: scale(1.2);
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.dot.active {
    animation: pulse 0.1s ease;
}
</style>

<script>
let audioContext = null;
let metronomeInterval;
let isPlaying = false;
const bpm = {{ song.bpm }};
const timeSignature = "{{ song.time_signature }}";
const [beats, _] = timeSignature.split('/').map(Number);
let currentBeat = 0;

function createAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioContext;
}

function playClick() {
    const context = createAudioContext();
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(context.destination);

    oscillator.frequency.value = 1000;
    gainNode.gain.value = 0.1;

    oscillator.start(context.currentTime);
    oscillator.stop(context.currentTime + 0.1);
}

function updateMetronomeDots() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, index) => {
        if (index === currentBeat) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
    currentBeat = (currentBeat + 1) % beats;
}

function startMetronome() {
    if (!isPlaying) {
        isPlaying = true;
        const interval = (60 / bpm) * 1000;
        
        createAudioContext(); // Initialize audio context on user interaction
        playClick(); // Play first click immediately
        
        metronomeInterval = setInterval(() => {
            playClick();
            updateMetronomeDots();
        }, interval);
        
        document.getElementById('startMetronome').innerHTML = '<i class="fas fa-stop me-2"></i>Stop Metronome';
    } else {
        stopMetronome();
    }
}

function stopMetronome() {
    isPlaying = false;
    clearInterval(metronomeInterval);
    document.getElementById('startMetronome').innerHTML = '<i class="fas fa-play me-2"></i>Start Metronome';
    currentBeat = 0;
    updateMetronomeDots();
}

document.getElementById('startMetronome').addEventListener('click', startMetronome);

// Cleanup when leaving the page
window.addEventListener('beforeunload', function() {
    if (metronomeInterval) {
        clearInterval(metronomeInterval);
    }
});
</script>
{% endblock %} 