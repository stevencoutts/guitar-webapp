{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="row g-4">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            <!-- Song Header -->
            <div class="song-header-modern mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="song-info">
                        <h1 class="song-title">{{ song.title }}</h1>
                            {% if song.artist %}
                        <p class="song-artist">by {{ song.artist }}</p>
                        {% endif %}
                        <div class="song-meta">
                            <span class="meta-badge">{{ song.time_signature }}</span>
                            <span class="meta-badge">{{ song.bpm }} BPM</span>
                            {% if song.capo != 'None' %}
                            <span class="meta-badge">Capo {{ song.capo }}</span>
                            {% endif %}
                        </div>
                        </div>
                        <div class="dropdown">
                        <button class="btn btn-ghost" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-h"></i>
                            </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('edit_song', song_id=song.id) }}">
                                    <i class="fas fa-edit me-2"></i>Edit Song
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="POST" action="{{ url_for('delete_song', song_id=song.id) }}" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="dropdown-item text-danger" 
                                                onclick="return confirm('Are you sure you want to delete this song?')">
                                        <i class="fas fa-trash me-2"></i>Delete Song
                                        </button>
                                    </form>
                                </li>
                            </ul>
                    </div>
                </div>
            </div>

            <!-- Chord Progression Card -->
            <div class="card-modern mb-4">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-music"></i>
                        Chord Progression
                    </h3>
                    <div class="btn-group-modern" role="group">
                        <button type="button" class="btn-toggle active" id="view-simple-btn" onclick="toggleProgessionView('simple')">
                            Simple
                                </button>
                        <button type="button" class="btn-toggle" id="view-formatted-btn" onclick="toggleProgessionView('formatted')">
                            Chart
                                </button>
                            </div>
                        </div>
                    
                <div class="card-body-modern">
                    <!-- Simple View -->
                    <div id="chord-progression-simple" class="chord-progression-view">
                        <div class="progression-simple">{{ song.chord_progression }}</div>
                    </div>
                    
                    <!-- Chart View -->
                    <div id="chord-progression-formatted" class="chord-progression-view" style="display: none;">
                        <div class="progression-controls mb-4">
                            <div class="d-flex gap-4 align-items-center flex-wrap">
                                <div class="form-check-modern">
                                        <input class="form-check-input" type="checkbox" id="show-bar-numbers" checked onchange="updateFormattedView()">
                                    <label class="form-check-label" for="show-bar-numbers">Bar numbers</label>
                                    </div>
                                <div class="form-check-modern">
                                        <input class="form-check-input" type="checkbox" id="highlight-on-click" checked>
                                    <label class="form-check-label" for="highlight-on-click">Click to highlight</label>
                                </div>
                            </div>
                        </div>
                        <div class="formatted-progression-container">
                            <div id="formatted-progression" class="formatted-progression">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chord Library Card -->
            <div class="card-modern mb-4">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-hand-paper"></i>
                        Chord Library
                    </h3>
                    </div>
                <div class="card-body-modern">
                    <div class="chord-grid-main">
                        {% if ordered_unique_chords %}
                            {% for chord_name in ordered_unique_chords %}
                                {% set shapes = chord_shapes_dict.get(chord_name, []) %}
                                <div class="chord-card-modern" data-chord-index="{{ loop.index0 }}" data-chord-name="{{ chord_name }}">
                                    <div class="chord-header">
                                        <h4 class="chord-name">{{ chord_name }}</h4>
                                        {% if shapes|length > 1 %}
                                        <select class="variant-select" onchange="changeChordVariant(this)">
                                            {% for shape in shapes %}
                                                {% set variant_value = shape.variant if shape.variant is not none else '' %}
                                                {% set variant_display = shape.variant if shape.variant is not none and shape.variant != '' else 'Default' %}
                                                {% set initial_shape = initial_shapes_dict.get(chord_name) %}
                                                <option value="{{ variant_value }}" {% if initial_shape and initial_shape.variant == variant_value %}selected{% endif %}>
                                                    {{ variant_display }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% endif %}
                </div>
                                    <div class="chord-diagram">
                                        {{ initial_diagram_svgs.get(chord_name) | safe }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <p>No chord shapes found.</p>
                            <a href="{{ url_for('admin_chords') }}" class="btn-primary-modern">Add Chords</a>
            </div>
            {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notes Card -->
            {% if song.notes %}
            <div class="card-modern">
                <div class="card-header-modern">
                    <h3 class="card-title-modern">
                        <i class="fas fa-sticky-note"></i>
                        Notes
                    </h3>
                </div>
                <div class="card-body-modern">
                    <div class="notes-content">{{ song.notes }}</div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sidebar-modern">
                <!-- Practice Tools -->
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">
                            <i class="fas fa-clock"></i>
                            Practice Tools
                        </h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="practice-controls">
                            <button class="btn-primary-modern w-100 mb-3" onclick="startMetronome()">
                                <i class="fas fa-clock me-2"></i>Start Metronome ({{ song.bpm }} BPM)
                        </button>
                            <button class="btn-secondary-modern w-100" onclick="stopMetronome()">
                            <i class="fas fa-stop me-2"></i>Stop Metronome
                        </button>
                    </div>
                        <div class="metronome-display mt-4">
                            <div class="metronome-dots" id="metronome-dots-container">
                                <!-- Dots will be dynamically generated based on time signature -->
                        </div>
                    </div>
                </div>
            </div>

                <!-- Strumming Pattern Card -->
                {% if song.strumming_pattern %}
                <div class="card-modern mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">
                            <i class="fas fa-guitar"></i>
                            Strumming Pattern
                        </h3>
                        <button class="btn-primary-modern" id="play-strumming-btn">
                            <i class="fas fa-play me-2"></i>Play Pattern
                        </button>
                        <button class="btn-secondary-modern" id="stop-strumming-btn" style="display: none;">
                            <i class="fas fa-stop me-2"></i>Stop
                        </button>
                    </div>
                    <div class="card-body-modern">
                        <div id="strumming-pattern-display"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Modern Design System */
    :root {
        --primary-color: #d32f2f;
        --primary-dark: #b71c1c;
        --text-primary: #1a1a1a;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --bg-white: #ffffff;
        --bg-gray-50: #f9fafb;
        --bg-gray-100: #f3f4f6;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
    }

    /* Reset and Base */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        background-color: var(--bg-gray-50);
        line-height: 1.6;
    }

    /* Song Header */
    .song-header-modern {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    .song-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
    }

    .song-artist {
        font-size: 1.25rem;
        color: var(--text-secondary);
        margin: 0 0 1rem 0;
        font-weight: 500;
    }

    .song-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .meta-badge {
        background: var(--bg-gray-100);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid var(--border-color);
    }

    /* Modern Cards */
    .card-modern {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .card-header-modern {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-gray-50);
        display: flex;
        justify-content: between;
        align-items: center;
        gap: 1rem;
    }

    .card-title-modern {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .card-title-modern i {
        color: var(--primary-color);
        font-size: 1.125rem;
    }

    .card-body-modern {
        padding: 1.5rem;
        width: 100%;
        box-sizing: border-box;
    }

    /* Buttons */
    .btn-primary-modern {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }

    .btn-primary-modern:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary-modern {
        background: var(--bg-white);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-secondary-modern:hover {
        background: var(--bg-gray-50);
        border-color: var(--text-secondary);
    }

    .btn-ghost {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 0.5rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-ghost:hover {
        background: var(--bg-gray-100);
        color: var(--text-primary);
    }

    .btn-ghost-small {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-ghost-small:hover {
        background: var(--bg-gray-50);
        border-color: var(--text-secondary);
    }

    /* Toggle Buttons */
    .btn-group-modern {
        display: flex;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .btn-toggle {
        background: var(--bg-white);
        color: var(--text-secondary);
        border: none;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border-right: 1px solid var(--border-color);
    }

    .btn-toggle:last-child {
        border-right: none;
    }

    .btn-toggle:hover {
        background: var(--bg-gray-50);
    }

    .btn-toggle.active {
        background: var(--primary-color);
        color: white;
    }

    /* Chord Progression */
    .progression-simple {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 2rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 1rem;
        line-height: 1.8;
        white-space: pre-wrap;
        color: var(--text-primary);
        max-height: 400px;
        overflow-y: auto;
    }

    /* Form Controls */
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .control-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .form-select-modern {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        background: var(--bg-white);
        color: var(--text-primary);
        min-width: 80px;
    }

    .form-check-modern {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-check-modern label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        cursor: pointer;
    }

    /* Sidebar */
    .sidebar-modern {
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
    }

    /* Practice Tools */
    .practice-controls {
        display: flex;
        flex-direction: column;
    }

    .metronome-display {
        text-align: center;
        display: none;
    }

    .metronome-dots {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-gray-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }

    .metronome-dot {
        width: 12px;
        height: 12px;
        background: var(--border-color);
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .metronome-dot.active {
        background: var(--primary-color);
        transform: scale(1.5);
        box-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
    }

    /* Chord Grid */
    .chord-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.35rem;
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
        margin: 0;
    }

    /* Chord Grid - Main Content Area (wider) */
    .chord-grid-main {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        width: 100%;
    }

    .chord-card-modern {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.35rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        min-height: 105px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 100%;
        box-sizing: border-box;
    }

    /* Larger chord cards for main content area */
    .chord-grid-main .chord-card-modern {
        padding: 0.3rem;
        min-height: 250px;
        width: 100%;
    }

    .chord-grid-main .chord-name {
        font-size: 0.9rem;
        margin: 0 0 0.3rem 0;
    }

    .chord-grid-main .chord-diagram {
        min-height: 190px;
        max-height: 210px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-grow: 1;
        overflow: visible;
        padding: 0.1rem 0.1rem 0.3rem 0.1rem;
        box-sizing: border-box;
    }

    .chord-grid-main .chord-diagram svg {
        width: 90%;
        height: auto;
        max-height: 220px;
        display: block;
    }

    .chord-card-modern:hover {
        background: var(--bg-white);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .chord-card-modern.highlighted {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-dark);
    }

    .chord-header {
        margin-bottom: 0.2rem;
        flex-shrink: 0;
        width: 100%;
    }

    .chord-name {
        font-size: 0.75rem;
        font-weight: 600;
        margin: 0 0 0.15rem 0;
        color: var(--text-primary);
        line-height: 1.1;
    }

    .chord-card-modern.highlighted .chord-name {
        color: white;
    }

    .variant-select {
        font-size: 0.55rem;
        padding: 0.1rem 0.2rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        background: var(--bg-white);
        width: 100%;
    }

    .chord-diagram {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
        min-height: 65px;
        overflow: visible;
        width: 100%;
    }

    .chord-diagram svg {
        max-width: 100%;
        max-height: 75px;
        width: auto;
        height: auto;
    }

    /* Notes */
    .notes-content {
        background: var(--bg-gray-50);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
        color: var(--text-primary);
    }

    /* Strumming Pattern */
    #strumming-pattern-display svg {
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background: var(--bg-gray-50);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    /* Scrollbars */
    .chord-grid::-webkit-scrollbar,
    .progression-simple::-webkit-scrollbar,
    .sidebar-modern::-webkit-scrollbar {
        width: 6px;
    }

    .chord-grid::-webkit-scrollbar-track,
    .progression-simple::-webkit-scrollbar-track,
    .sidebar-modern::-webkit-scrollbar-track {
        background: var(--bg-gray-100);
        border-radius: 3px;
    }

    .chord-grid::-webkit-scrollbar-thumb,
    .progression-simple::-webkit-scrollbar-thumb,
    .sidebar-modern::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }

    .chord-grid::-webkit-scrollbar-thumb:hover,
    .progression-simple::-webkit-scrollbar-thumb:hover,
    .sidebar-modern::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }

    /* Responsive Design */
    @media (max-width: 991.98px) {
        .sidebar-modern {
            position: static;
            max-height: none;
            margin-top: 2rem;
        }

        .song-title {
            font-size: 2rem;
        }

        .chord-card-modern {
            padding: 0.3rem;
            min-height: 95px;
        }

        .chord-diagram {
            min-height: 60px;
        }

        .chord-diagram svg {
            max-height: 70px;
        }

        /* Main chord grid - reduce to 3 columns on tablets */
        .chord-grid-main {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .chord-grid-main .chord-card-modern {
            padding: 0.5rem;
            min-height: 120px;
        }

        .chord-grid-main .chord-diagram svg {
            max-height: 90px;
        }
    }

    @media (max-width: 767.98px) {
        .song-header-modern,
        .card-body-modern {
            padding: 1rem;
        }

        .card-header-modern {
            padding: 0.75rem 1rem;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }

        .song-title {
            font-size: 1.75rem;
        }

        .meta-badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .chord-grid {
            gap: 0.25rem;
        }

        .chord-card-modern {
            min-height: 85px;
            padding: 0.25rem;
        }

        .chord-name {
            font-size: 0.7rem;
        }

        .chord-diagram {
            min-height: 55px;
        }

        .chord-diagram svg {
            max-height: 65px;
        }

        /* Main chord grid - 2 columns on mobile */
        .chord-grid-main {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .chord-grid-main .chord-card-modern {
            padding: 0.4rem;
            min-height: 110px;
        }

        .chord-grid-main .chord-name {
            font-size: 0.85rem;
        }

        .chord-grid-main .chord-diagram svg {
            max-height: 80px;
        }

        .progression-controls {
            flex-direction: column;
            gap: 1rem;
        }

        .progression-controls .d-flex {
            flex-direction: column;
            align-items: stretch !important;
        }
    }

    @media (max-width: 576px) {
        .chord-card-modern {
            min-height: 80px;
            padding: 0.2rem;
        }

        .chord-name {
            font-size: 0.65rem;
        }

        .chord-diagram {
            min-height: 50px;
        }

        .chord-diagram svg {
            max-height: 60px;
        }

        /* Main chord grid - keep 2 columns but smaller */
        .chord-grid-main .chord-card-modern {
            padding: 0.3rem;
            min-height: 100px;
        }

        .chord-grid-main .chord-name {
            font-size: 0.75rem;
        }

        .chord-grid-main .chord-diagram svg {
            max-height: 70px;
        }
    }

    /* Dropdown Improvements */
    .dropdown-menu {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        padding: 0.5rem;
    }

    .dropdown-item {
        border-radius: var(--radius-sm);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background: var(--bg-gray-50);
    }

    /* Formatted progression specific styles */
    .bar-container {
        margin-bottom: 1rem;
    }
    
    .bar-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }
    
    .bar-label-inline {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        margin-right: 1rem;
        align-self: center;
        flex-shrink: 0;
        min-width: 3.5rem;
    }
    
    .chord-boxes-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }
    
    .chord-box {
        background: var(--bg-white);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        min-width: 3rem;
        text-align: center;
    }
    
    .chord-box:hover {
        background: var(--bg-gray-50);
        border-color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .chord-box.highlighted {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-dark);
        box-shadow: var(--shadow-md);
    }
    
    .half-measure-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding: 0.25rem;
        border-radius: var(--radius-md);
        background: rgba(211, 47, 47, 0.05);
        border: 1px dashed var(--primary-color);
    }
    
    .half-measure-chord {
        margin: 0;
        min-width: 2.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
</style>

<script>
// Global variables
let isMetronomePlaying = false;
let metronomeInterval;
let strummingPatternData = [];
let currentProgressionView = 'simple';

// Audio context for sound generation
let audioContext;
let isAudioInitialized = false;

// Initialize audio context
function initializeAudio() {
    if (!isAudioInitialized) {
         audioContext = new (window.AudioContext || window.webkitAudioContext)();
        isAudioInitialized = true;
    }
    return audioContext;
     }

// Generate metronome click sound
function playMetronomeClick(isDownbeat = false) {
    const ctx = initializeAudio();

    // Create oscillator for the click
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    // Connect audio nodes
     oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    // Set frequency (higher for downbeat, lower for other beats)
    oscillator.frequency.value = isDownbeat ? 1000 : 800;
    oscillator.type = 'square';
    
    // Set volume envelope (quick attack and decay for click sound)
    const now = ctx.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(0.1, now + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
    
    // Play the sound
    oscillator.start(now);
    oscillator.stop(now + 0.1);
}

// Generate strumming sound
function playStrummingSound(strumType) {
    const ctx = initializeAudio();
    
    if (strumType === '-') return; // No sound for rest
    
    // Create noise for guitar-like sound
    const bufferSize = ctx.sampleRate * 0.1; // 100ms of audio
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    
    // Generate filtered noise for strum sound
    for (let i = 0; i < bufferSize; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.3));
    }
    
    const source = ctx.createBufferSource();
    const filter = ctx.createBiquadFilter();
    const gainNode = ctx.createGain();
    
    source.buffer = buffer;
    
    // Set filter based on strum type
    filter.type = 'bandpass';
    filter.frequency.value = strumType === 'D' ? 200 : 400; // Down strum lower, up strum higher
    filter.Q.value = 5;
    
    // Set volume based on strum type
    gainNode.gain.value = strumType === 'X' ? 4.0 : 6.0; // Muted strum quieter
    
    // Connect nodes
    source.connect(filter);
    filter.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    // Play the sound
    source.start();
}

// Metronome functions
function startMetronome() {
    if (isMetronomePlaying) return;
    
    // Initialize audio context on user interaction
    initializeAudio();
    
    isMetronomePlaying = true;
    const bpm = {{ song.bpm }};
    const timeSignature = "{{ song.time_signature }}";
    const beatsPerMeasure = parseInt(timeSignature.split('/')[0]) || 4;
    const interval = 60000 / bpm;
    
    let beatCount = 0;
    
    // Create the correct number of dots based on time signature
    const dotsContainer = document.getElementById('metronome-dots-container');
    dotsContainer.innerHTML = ''; // Clear existing dots
    
    for (let i = 0; i < beatsPerMeasure; i++) {
        const dot = document.createElement('span');
        dot.className = 'metronome-dot';
        dotsContainer.appendChild(dot);
    }
    
    const dots = document.querySelectorAll('.metronome-display .metronome-dot');
    
    // Show metronome display
    document.querySelector('.metronome-display').style.display = 'block';
    
    function beat() {
        if (!isMetronomePlaying) return;
        
        // Play metronome click sound (downbeat on beat 1)
        playMetronomeClick(beatCount === 0);
        
        // Reset all dots
        dots.forEach(dot => dot.classList.remove('active'));
        
        // Activate current beat dot
        if (dots[beatCount]) {
            dots[beatCount].classList.add('active');
        }
        
        beatCount = (beatCount + 1) % beatsPerMeasure;
        
        metronomeInterval = setTimeout(beat, interval);
    }
    
    beat();
}

function stopMetronome() {
    isMetronomePlaying = false;
    clearTimeout(metronomeInterval);

    // Remove active state from dots
    document.querySelectorAll('.metronome-display .metronome-dot').forEach(dot => {
        dot.classList.remove('active');
    });
    
    // Hide metronome display
    document.querySelector('.metronome-display').style.display = 'none';
}

// Chord variant change function
function changeChordVariant(selectElement) {
    const variant = selectElement.value;
    const chordCard = selectElement.closest('.chord-card-modern');
    const chordName = chordCard.getAttribute('data-chord-name');
    const diagramContainer = chordCard.querySelector('.chord-diagram');
    
    // Update chord diagram
    updateChordDiagram(chordName, variant, diagramContainer);
    
    // Save selected variant
    saveSelectedVariant(chordName, variant);
}

// Function to render the strumming pattern as SVG
function renderStrummingPattern() {
    const container = document.getElementById('strumming-pattern-display');
    if (!container) {
        return;
    }

    // Get strumming pattern data passed from Flask
    let rawStrummingData = {{ song.strumming_pattern_list | tojson }};
    const numberOfBeats = {{ song.display_beats | tojson }}; // Number of beats to display
    const timeSignature = "{{ song.time_signature }}"; // Get time signature
    
    // Handle different data formats
    let strummingPatternData;
    let beatSubdivisions;
    
    // Parse time signature to get beats per measure  
    function parseTimeSignature(timeSignatureStr) {
        const parts = (timeSignatureStr || '4/4').split('/');
        if (parts.length === 2) {
            const numerator = parseInt(parts[0]);
            const denominator = parseInt(parts[1]);
            
            // Handle traditional compound time signatures with special groupings
            if (denominator === 8 && numerator === 6) {
                return 2; // 6/8 is typically felt in 2
            } else if (denominator === 8 && numerator === 9) {
                return 3; // 9/8 is typically felt in 3
            } else if (denominator === 8 && numerator === 12) {
                return 4; // 12/8 is typically felt in 4
            } else {
                // For all other time signatures (including irrational ones), use the numerator
                // The numerator always represents the number of beats per measure
                return numerator;
            }
        }
        return 4; // Default to 4/4 if parsing fails
    }
    
    const beatsPerMeasure = parseTimeSignature(timeSignature);
    
    if (typeof rawStrummingData === 'object' && rawStrummingData !== null && 'pattern' in rawStrummingData) {
        // New triplet format
        strummingPatternData = rawStrummingData.pattern;
        beatSubdivisions = rawStrummingData.subdivisions || [];
    } else if (Array.isArray(rawStrummingData)) {
        // Legacy format: create subdivisions array assuming all regular beats
        strummingPatternData = rawStrummingData;
        
        // Special handling for time signatures with denominator 3 (like 4/3)
        const timeSignatureParts = timeSignature.split('/');
        if (timeSignatureParts.length === 2 && parseInt(timeSignatureParts[1]) === 3) {
            // For time signatures with denominator 3, each beat gets 3 subdivisions
            beatSubdivisions = Array(beatsPerMeasure).fill(3);
        } else if (timeSignature === '4/4') {
            // For 4/4 time signature, use 4 subdivisions per beat (16th notes)
            beatSubdivisions = Array(beatsPerMeasure).fill(4);
        } else {
            // Default to 2 subdivisions per beat for other time signatures
            beatSubdivisions = Array(beatsPerMeasure).fill(2);
        }
    } else {
        // Invalid format
        strummingPatternData = [];
        
        // Special handling for time signatures with denominator 3 (like 4/3)
        const timeSignatureParts = timeSignature.split('/');
        if (timeSignatureParts.length === 2 && parseInt(timeSignatureParts[1]) === 3) {
            beatSubdivisions = Array(beatsPerMeasure).fill(3);
        } else if (timeSignature === '4/4') {
            // For 4/4 time signature, use 4 subdivisions per beat (16th notes)
            beatSubdivisions = Array(beatsPerMeasure).fill(4);
            } else {
            beatSubdivisions = Array(beatsPerMeasure).fill(2);
        }
    }

    if (!Array.isArray(strummingPatternData) || strummingPatternData.length === 0) {
        container.innerHTML = '<p class="text-muted">No strumming pattern available</p>';
        return;
    }

    // SVG dimensions
    const svgWidth = container.offsetWidth || 600;
    const svgHeight = 120;
    const margin = { top: 20, right: 20, bottom: 20, left: 40 };
    const plotWidth = svgWidth - margin.left - margin.right;
    const plotHeight = svgHeight - margin.top - margin.bottom;

    // Create SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', svgWidth);
    svg.setAttribute('height', svgHeight);
    svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
    svg.style.background = '#f8f9fa';
    svg.style.border = '1px solid #dee2e6';
    svg.style.borderRadius = '8px';

    // Calculate total slots across all beats
    let totalSlots = 0;
    for (let beat = 0; beat < numberOfBeats; beat++) {
        const beatIndex = beat % beatsPerMeasure;
        const subdivisions = beatSubdivisions[beatIndex] || 2;
        totalSlots += subdivisions;
    }

    const slotWidth = plotWidth / totalSlots;
    
    let currentSlot = 0;
    
    // Draw beat labels and pattern
    for (let beat = 0; beat < numberOfBeats; beat++) {
        const beatIndex = beat % beatsPerMeasure;
        const subdivisions = beatSubdivisions[beatIndex] || 2;
        const beatStartX = margin.left + currentSlot * slotWidth;
        const beatEndX = margin.left + (currentSlot + subdivisions) * slotWidth;
        const beatCenterX = (beatStartX + beatEndX) / 2;
            
            // Draw beat number
        const beatLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        beatLabel.setAttribute('x', beatCenterX);
        beatLabel.setAttribute('y', margin.top - 10);
        beatLabel.setAttribute('text-anchor', 'middle');
        beatLabel.setAttribute('font-size', '12');
        beatLabel.setAttribute('font-weight', 'bold');
        
        // Check if this is a time signature with denominator 3 (like 4/3)
        const timeSignatureParts = timeSignature.split('/');
        const isDenominator3 = timeSignatureParts.length === 2 && parseInt(timeSignatureParts[1]) === 3;
        
        beatLabel.setAttribute('fill', (subdivisions === 3 || isDenominator3) ? '#dc3545' : '#212529');
        beatLabel.textContent = (beat % beatsPerMeasure) + 1;
        svg.appendChild(beatLabel);
        
        // Draw subdivision markers
            for (let sub = 0; sub < subdivisions; sub++) {
            const slotIndex = currentSlot + sub;
            if (slotIndex >= strummingPatternData.length) break;
            
            const x = margin.left + (currentSlot + sub + 0.5) * slotWidth;
            const y = margin.top + plotHeight / 2;
            
            const strum = strummingPatternData[slotIndex];
            let symbol = '';
            let color = '#6c757d';
            
            switch (strum) {
                case 'D':
                    symbol = '↓';
                    color = '#28a745';
                    break;
                case 'U':
                    symbol = '↑';
                    color = '#17a2b8';
                    break;
                case 'X':
                    symbol = 'X';
                    color = '#dc3545';
                    break;
                case '-':
                default:
                    symbol = '-';
                    color = '#6c757d';
                    break;
            }
            
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', y + 5);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('font-size', '18');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', color);
            text.textContent = symbol;
            svg.appendChild(text);
            
            // Draw subdivision separator
            if (sub < subdivisions - 1) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', margin.left + (currentSlot + sub + 1) * slotWidth);
                line.setAttribute('y1', margin.top + 10);
                line.setAttribute('x2', margin.left + (currentSlot + sub + 1) * slotWidth);
                line.setAttribute('y2', margin.top + plotHeight - 10);
                line.setAttribute('stroke', '#dee2e6');
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);
            }
        }
        
        // Draw beat separator (heavier line)
        if (beat < numberOfBeats - 1) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', beatEndX);
            line.setAttribute('y1', margin.top);
            line.setAttribute('x2', beatEndX);
            line.setAttribute('y2', margin.top + plotHeight);
            line.setAttribute('stroke', '#495057');
            line.setAttribute('stroke-width', '2');
            svg.appendChild(line);
        }
        
        currentSlot += subdivisions;
    }

    // Clear container and add SVG
    container.innerHTML = '';
    container.appendChild(svg);
}

function updateChordDiagram(chordName, variant, container) {
    const encodedChordName = encodeURIComponent(chordName);
    const variantParam = variant ? `?variant=${encodeURIComponent(variant)}` : '';
    const newUrl = `/chord/${encodedChordName}${variantParam}`;
    
    // Create a new object element to load the new SVG
    const newObject = document.createElement('object');
    newObject.data = newUrl;
    newObject.type = 'image/svg+xml';
    newObject.className = 'chord-diagram';
    newObject.textContent = `${chordName} diagram`;
    
    // Replace the existing diagram
    container.innerHTML = '';
    container.appendChild(newObject);
}

// Function to save selected variant
function saveSelectedVariant(chordName, variant) {
    fetch(`/song/{{ song.id }}/save_variant`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            chord_name: chordName,
            variant: variant
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Failed to save variant');
        }
    })
    .catch(error => {
        console.error('Error saving variant:', error);
    });
}

// Enhanced Chord Progression Functions
function toggleProgessionView(view) {
    // Update button states
    document.querySelectorAll('.btn-group-modern button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view-${view}-btn`).classList.add('active');
    
    // Hide all views
    document.querySelectorAll('.chord-progression-view').forEach(viewEl => viewEl.style.display = 'none');
    
    // Show selected view
    document.getElementById(`chord-progression-${view}`).style.display = 'block';
    
    currentProgressionView = view;
    
    // Initialize the view if needed
    if (view === 'formatted') {
        updateFormattedView();
    }
}

// Parse chord progression from text
function parseChordProgression(text) {
    const lines = text.split('\n');
    const parsedLines = [];
    
    lines.forEach(line => {
        const trimmedLine = line.trim();
        if (trimmedLine.length === 0) return;
        
        // Split by spaces but keep | | notation intact
        const parts = trimmedLine.split(/\s+/);
        const chords = [];
        let inHalfMeasure = false;
        let currentHalfMeasure = [];
        
        parts.forEach(part => {
            if (part === '|') {
                if (inHalfMeasure) {
                    // End of half measure
                    chords.push({
                        type: 'half-measure',
                        chords: currentHalfMeasure
                    });
                    currentHalfMeasure = [];
                    inHalfMeasure = false;
                } else {
                    // Start of half measure
                    inHalfMeasure = true;
                }
            } else if (part.match(/^[A-G][#b]?[^\s]*$/) || part.includes('/')) {
                // This is a chord
                if (inHalfMeasure) {
                    currentHalfMeasure.push({
                        chord: part,
                        original: part
                    });
                } else {
                    chords.push({
                        type: 'chord',
                        chord: part,
                        original: part
                    });
                }
            }
        });
        
        // Handle case where half measure wasn't closed
        if (inHalfMeasure && currentHalfMeasure.length > 0) {
            chords.push({
                type: 'half-measure',
                chords: currentHalfMeasure
            });
        }
        
        if (chords.length > 0) {
            parsedLines.push(chords);
        }
    });
    
    return parsedLines;
}

function updateFormattedView() {
    const container = document.getElementById('formatted-progression');
    const showBarNumbers = document.getElementById('show-bar-numbers').checked;
    
    container.innerHTML = '';
    
    const chordProgressionData = `{{ song.chord_progression }}`;
    const parsedLines = parseChordProgression(chordProgressionData);
    
    if (parsedLines.length === 0) {
        container.innerHTML = '<p class="text-muted">No chords found in progression</p>';
        return;
    }
    
    let barNumber = 1;
    
    parsedLines.forEach(lineChords => {
        // Create bar container
        const barContainer = document.createElement('div');
        barContainer.className = 'bar-container mb-4';
        
        // Create chord boxes container
        const chordBoxesContainer = document.createElement('div');
        chordBoxesContainer.className = 'chord-boxes-container';
        
        if (showBarNumbers) {
            const barLabel = document.createElement('div');
            barLabel.className = 'bar-label-inline';
            barLabel.textContent = `Bar ${barNumber}`;
            chordBoxesContainer.appendChild(barLabel);
        }
        
        lineChords.forEach((item, index) => {
            if (item.type === 'half-measure') {
                // Create half measure group
                const halfMeasureGroup = document.createElement('div');
                halfMeasureGroup.className = 'half-measure-group';
                
                item.chords.forEach((chordObj, chordIndex) => {
                    const chordBox = document.createElement('div');
                    chordBox.className = 'chord-box half-measure-chord';
                    chordBox.textContent = chordObj.chord;
                    chordBox.setAttribute('data-chord', chordObj.chord);
                    
                    if (document.getElementById('highlight-on-click').checked) {
                        chordBox.addEventListener('click', function() {
                            highlightChord(this.getAttribute('data-chord'));
                        });
                    }
                    
                    halfMeasureGroup.appendChild(chordBox);
                });
                
                chordBoxesContainer.appendChild(halfMeasureGroup);
                
            } else if (item.type === 'chord') {
                // Create regular chord box
                const chordBox = document.createElement('div');
                chordBox.className = 'chord-box';
                chordBox.textContent = item.chord;
                chordBox.setAttribute('data-chord', item.chord);
                
                if (document.getElementById('highlight-on-click').checked) {
                    chordBox.addEventListener('click', function() {
                        highlightChord(this.getAttribute('data-chord'));
                    });
                }
                
                chordBoxesContainer.appendChild(chordBox);
            }
        });
        
        barContainer.appendChild(chordBoxesContainer);
        container.appendChild(barContainer);
        barNumber++;
    });
}

function highlightChord(chordName) {
    // Remove existing highlights
    document.querySelectorAll('.progression-chord.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });
    
    // Highlight matching chords
    document.querySelectorAll(`[data-chord="${chordName}"]`).forEach(el => {
        el.classList.add('highlighted');
    });
    
    // Also highlight chord diagram if visible
    const chordCard = document.querySelector(`[data-chord-name="${chordName}"]`);
    if (chordCard) {
        document.querySelectorAll('.chord-card-modern.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });
        chordCard.classList.add('highlighted');
    }
}

// Strumming pattern playback
let isStrummingPlaying = false;
let strummingInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Render the strumming pattern SVG on page load
    renderStrummingPattern();

    // Assign the strumming pattern data to the global variable after DOM is loaded
    let rawStrummingData = {{ song.strumming_pattern_list | tojson }};
    
    // Handle different data formats for playback
    if (typeof rawStrummingData === 'object' && rawStrummingData !== null && 'pattern' in rawStrummingData) {
        // New triplet format: extract the pattern array
        strummingPatternData = rawStrummingData.pattern;
    } else if (Array.isArray(rawStrummingData)) {
        // Legacy format: use directly
        strummingPatternData = rawStrummingData;
    } else {
        // Invalid format
        strummingPatternData = [];
    }
    
    // Set up strumming pattern playback
    const playBtn = document.getElementById('play-strumming-btn');
    const stopBtn = document.getElementById('stop-strumming-btn');
    
    if (playBtn) {
        playBtn.addEventListener('click', function() {
            if (isStrummingPlaying) return;
            
            // Initialize audio context on user interaction
            initializeAudio();
            
            isStrummingPlaying = true;
            playBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            
            const bpm = {{ song.bpm }};
            const timeSignature = "{{ song.time_signature }}";
            
            // Calculate interval based on time signature and subdivision
            const beatInterval = 60000 / bpm;
            
            // Determine subdivisions per beat based on time signature
            const timeSignatureParts = timeSignature.split('/');
            let subdivisionsPerBeat = 2; // Default
            
            if (timeSignatureParts.length === 2 && parseInt(timeSignatureParts[1]) === 3) {
                // For time signatures with denominator 3 (like 4/3), each beat has 3 subdivisions
                subdivisionsPerBeat = 3;
            } else if (timeSignature === '4/4') {
                // For 4/4 time signature, use 4 subdivisions per beat (16th notes)
                subdivisionsPerBeat = 4;
            }
            
            const subdivisionInterval = beatInterval / subdivisionsPerBeat;
            
            let patternIndex = 0;
            
            function playNextStrum() {
                if (!isStrummingPlaying) return;
                
                if (patternIndex >= strummingPatternData.length) {
                    patternIndex = 0; // Loop the pattern
                }
                
                // Play the actual strum sound
                const strumType = strummingPatternData[patternIndex];
                playStrummingSound(strumType);
                
                patternIndex++;
                strummingInterval = setTimeout(playNextStrum, subdivisionInterval);
            }
            
            playNextStrum();
        });
    }
    
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            isStrummingPlaying = false;
            clearTimeout(strummingInterval);
            
            playBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
        });
    }

    // Initialize chord progression
    updateFormattedView();
});
</script>

<style>
    /* Formatted progression specific styles */
    .progression-line {
        margin-bottom: 0.75rem;
        line-height: 1.8;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 1rem;
    }
    
    .line-number {
        font-size: 0.85rem;
        color: #6c757d;
        margin-right: 0.75rem;
        font-weight: 600;
    }
    
    .half-measure-container {
        background: rgba(211, 47, 47, 0.05);
        border-radius: 4px;
        padding: 0.1rem 0.3rem;
        margin: 0 0.2rem;
    }
    
    .pipe-separator {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .progression-chord {
        display: inline-block;
        min-width: 2.5rem;
        text-align: center;
        padding: 0.2rem 0.4rem;
        margin: 0 0.1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }
    
    .progression-chord:hover {
        background-color: #e9ecef;
    }
    
    .progression-chord.highlighted {
        background-color: #d32f2f;
        color: white;
    }
    
    .chord-card-modern.highlighted {
        background-color: #d32f2f !important;
        color: white;
    }
    
    .chord-card-modern.highlighted .chord-name {
        color: white;
    }
</style>
{% endblock %}