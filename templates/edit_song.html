{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">Edit Song</h2>
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ song.title }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="artist" class="form-label">Artist</label>
                        <input type="text" class="form-control" id="artist" name="artist" value="{{ song.artist or '' }}" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label for="time_signature" class="form-label">Time Signature</label>
                        <input type="text" class="form-control" id="time_signature" name="time_signature" value="{{ song.time_signature }}" required>
                        <small class="form-text text-muted">Format: 4/4, 3/4, etc.</small>
                    </div>
                    <div class="mb-3">
                        <label for="bpm" class="form-label">BPM</label>
                        <input type="number" class="form-control" id="bpm" name="bpm" value="{{ song.bpm }}" min="20" max="300" required>
                    </div>
                    <div class="mb-3">
                        <label for="capo" class="form-label">Capo Position</label>
                        <select class="form-select" id="capo" name="capo">
                            <option value="None" {% if song.capo == 'None' %}selected{% endif %}>None</option>
                            <option value="1" {% if song.capo == '1' %}selected{% endif %}>1st fret</option>
                            <option value="2" {% if song.capo == '2' %}selected{% endif %}>2nd fret</option>
                            <option value="3" {% if song.capo == '3' %}selected{% endif %}>3rd fret</option>
                            <option value="4" {% if song.capo == '4' %}selected{% endif %}>4th fret</option>
                            <option value="5" {% if song.capo == '5' %}selected{% endif %}>5th fret</option>
                            <option value="6" {% if song.capo == '6' %}selected{% endif %}>6th fret</option>
                            <option value="7" {% if song.capo == '7' %}selected{% endif %}>7th fret</option>
                            <option value="8" {% if song.capo == '8' %}selected{% endif %}>8th fret</option>
                            <option value="9" {% if song.capo == '9' %}selected{% endif %}>9th fret</option>
                            <option value="10" {% if song.capo == '10' %}selected{% endif %}>10th fret</option>
                            <option value="11" {% if song.capo == '11' %}selected{% endif %}>11th fret</option>
                            <option value="12" {% if song.capo == '12' %}selected{% endif %}>12th fret</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chord_progression" class="form-label">Chord Progression</label>
                        <textarea class="form-control" id="chord_progression" name="chord_progression" rows="3" required>{{ song.chord_progression }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="strumming_pattern" class="form-label">Strumming Pattern</label>
                        <svg id="strummingPatternEditor" width="400" height="100"></svg>
                        <input type="hidden" id="strumming_pattern" name="strumming_pattern" required>
                        
                        <div class="mt-2">
                           <label for="display_beats" class="form-label">Display Beats:</label>
                           <select id="display_beats" name="display_beats" class="form-select form-select-sm d-inline-block w-auto">
                               <option value="4">4 Beats (1 Bar)</option>
                               <option value="8">8 Beats (2 Bars)</option>
                           </select>
                        </div>
                        <input type="hidden" id="selected_display_beats" name="display_beats" value="{{ song.display_beats if song else 4 }}">
                        
                        <div class="form-text">Click on the pattern slots to change strum direction (↓, ↑, - , X)</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
                <hr class="my-4">
                <form method="POST" action="{{ url_for('delete_song', song_id=song.id) }}" onsubmit="return confirm('Are you sure you want to delete this song?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Delete Song</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass initial strumming pattern data from Flask/Jinja to JavaScript
    const initialStrummingPatternJson = {{ song.strumming_pattern | tojson }};
    const initialDisplayBeats = {{ initial_display_beats }};
</script>
<script>
    const svg = document.getElementById('strummingPatternEditor');
    const hiddenInput = document.getElementById('strumming_pattern');
    const displayBeatsSelect = document.getElementById('display_beats');
    const selectedDisplayBeatsInput = document.getElementById('selected_display_beats');

    const beatUnit = 4; // Number of 16th notes per beat (e.g., 4 for 4/4 time)
    let numberOfBeats = initialDisplayBeats; // Initialize with the saved value
    let totalSlots = beatUnit * numberOfBeats;
    const slotWidth = 25; // Width of each 16th note slot
    const slotHeight = 30; // Height of each slot
    const startX = 10;
    const startY = 20; // Reset startY, numbers will be adjusted in drawGrid

    // Initialize with rests, or load from saved pattern later
    let strummingPattern = Array(totalSlots).fill('-');

    const strummingSymbols = ['D', 'U', '-', 'X']; // Down, Up, Rest, Mute (Internal representation)
    const displaySymbols = ['↓', '↑', '-', 'X']; // Display representation

    function drawGrid() {
        // Calculate dynamic width based on totalSlots and slotWidth, plus margins
        const dynamicWidth = startX + totalSlots * slotWidth + startX; // startX on both sides as padding
        // Adjust width and height based on number of lines
        const isTwoLine = numberOfBeats > 4; // Assuming 8 beats will be two lines
        const svgWidth = startX + (isTwoLine ? 4 : numberOfBeats) * beatUnit * slotWidth + startX; // Width based on 4 beats per line or single line
        const svgHeight = isTwoLine ? startY + 2 * (slotHeight + 20) : startY + slotHeight + 20; // Double height for two lines
        
        svg.setAttribute('width', svgWidth);
        svg.setAttribute('height', svgHeight);

        svg.innerHTML = ''; // Clear previous drawings

        // Draw horizontal lines for beats
        for (let line = 0; line < (isTwoLine ? 2 : 1); line++) {
            const lineStartY = startY + line * (slotHeight + 20); // Vertical offset for the second line
            const beatsOnLine = isTwoLine ? 4 : numberOfBeats;
            for (let i = 0; i <= beatsOnLine; i++) {
                const x = startX + i * beatUnit * slotWidth;
                svg.innerHTML += `<line x1="${x}" y1="${lineStartY}" x2="${x}" y2="${lineStartY + slotHeight}" stroke="black" stroke-width="2"/>`;
            }
        }

        // Draw vertical lines for divisions (16th notes)
        for (let line = 0; line < (isTwoLine ? 2 : 1); line++) {
            const lineStartY = startY + line * (slotHeight + 20);
            const slotsOnLine = (isTwoLine ? 4 : numberOfBeats) * beatUnit;
            for (let i = 0; i <= slotsOnLine; i++) {
                const x = startX + i * slotWidth;
                if (i % beatUnit !== 0) { // Avoid redrawing beat lines
                     svg.innerHTML += `<line x1="${x}" y1="${lineStartY}" x2="${x}" y2="${lineStartY + slotHeight}" stroke="grey" stroke-width="1"/>`;
                }
            }
        }

        // Add beat numbers
        for (let line = 0; line < (isTwoLine ? 2 : 1); line++) {
            const lineStartY = startY + line * (slotHeight + 20);
            const beatsOnLine = isTwoLine ? 4 : numberOfBeats;
            for (let i = 0; i < beatsOnLine; i++) {
                // Position x to be centered over the start of each beat
                const x = startX + i * beatUnit * slotWidth; // Align with the beat line
                // Position y slightly above the grid lines for the current line
                const y = lineStartY - 8; // Adjusted y position for beat numbers

                svg.innerHTML += `<text x="${x}" y="${y}" text-anchor="middle" font-size="12">${i + 1}</text>`;
            }
        }

        // Draw interactive slots and symbols
        for (let i = 0; i < totalSlots; i++) {
            const line = Math.floor(i / (4 * beatUnit)); // Determine which line (0 or 1)
            const indexOnLine = i % (4 * beatUnit); // Index within the current line
            const x = startX + indexOnLine * slotWidth;
            const y = startY + line * (slotHeight + 20); // Vertical offset for the second line

            // Create a clickable area for each slot
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', slotWidth);
            rect.setAttribute('height', slotHeight);
            rect.setAttribute('fill', 'transparent'); // Make it invisible but clickable
            rect.setAttribute('data-index', i); // Store the index of the slot
            svg.appendChild(rect);

            // Add event listener to the rect
            rect.addEventListener('click', handleClick);

            // Add symbol text (initial or from strummingPattern array)
            const symbolText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            symbolText.setAttribute('x', x + slotWidth / 2);
            symbolText.setAttribute('y', y + slotHeight / 2 + 5); // Adjust for vertical centering
            symbolText.setAttribute('text-anchor', 'middle');
            symbolText.setAttribute('font-size', '18');
            symbolText.setAttribute('fill', 'black');
            symbolText.classList.add('strum-symbol'); // Add a class for easy selection
             // Get the display symbol based on the current value in strummingPattern array
            const currentSymbol = strummingPattern[i];
            const symbolIndex = strummingSymbols.indexOf(currentSymbol);
            symbolText.textContent = (symbolIndex !== -1) ? displaySymbols[symbolIndex] : '?'; // Use ? for unknown symbols

            symbolText.setAttribute('data-index', i); // Store the index on the text too
            svg.appendChild(symbolText);
        }
    }

    function handleClick(event) {
        const index = parseInt(event.target.getAttribute('data-index'));
        const currentSymbol = strummingPattern[index];
        let currentIndex = strummingSymbols.indexOf(currentSymbol);
         // If current symbol is not found, default to -1 so nextIndex starts from 0 (first symbol)
        if (currentIndex === -1) {
            currentIndex = -1;
        }
        const nextIndex = (currentIndex + 1) % strummingSymbols.length;
        const nextSymbol = strummingSymbols[nextIndex];

        strummingPattern[index] = nextSymbol; // Update the internal pattern array

        // Update the displayed symbol in the SVG
        const symbolTextElement = svg.querySelector(`.strum-symbol[data-index='${index}']`);
        if(symbolTextElement) {
            symbolTextElement.textContent = displaySymbols[nextIndex];
        }

        updateHiddenInput(); // Update the hidden input field
    }

    function updateHiddenInput() {
        hiddenInput.value = JSON.stringify(strummingPattern);
    }

    // Function to redraw the grid and update pattern when beats selection changes
    function updateDisplayBeats(newNumberOfBeats) {
        numberOfBeats = newNumberOfBeats;
        const oldTotalSlots = strummingPattern.length;
        totalSlots = beatUnit * numberOfBeats;

        // Adjust strummingPattern array size if necessary
        if (totalSlots > oldTotalSlots) {
            // If increasing beats, pad with rests
            strummingPattern = strummingPattern.concat(Array(totalSlots - oldTotalSlots).fill('-'));
        } else if (totalSlots < oldTotalSlots) {
            // If decreasing beats, truncate the array
            strummingPattern = strummingPattern.slice(0, totalSlots);
        }

        // Update the hidden input for form submission
        selectedDisplayBeatsInput.value = numberOfBeats;

        drawGrid(); // Redraw the grid with the new settings
        updateHiddenInput(); // Update the hidden input with the adjusted pattern
    }

    // Add event listener to the display beats select dropdown
    displayBeatsSelect.addEventListener('change', (event) => {
        const newBeats = parseInt(event.target.value, 10);
        updateDisplayBeats(newBeats);
    });

    // Load initial pattern if editing an existing song
    if (initialStrummingPatternJson) { // Check if the string is not empty
        try {
            const parsedPattern = JSON.parse(initialStrummingPatternJson);
            console.log('Parsed initial pattern:', parsedPattern);

            if (Array.isArray(parsedPattern)) {
                if (parsedPattern.length === totalSlots) {
                    strummingPattern = parsedPattern;
                    console.log('Strumming pattern successfully loaded.', strummingPattern);
                } else {
                    console.warn(`Parsed strumming pattern length (${parsedPattern.length}) does not match expected totalSlots (${totalSlots}). Using default pattern.`);
                    strummingPattern = Array(totalSlots).fill('-'); // Reset to default if length is unexpected
                }
            } else {
                console.error('Invalid or unexpected strumming pattern data: Parsed data is not an array.');
                strummingPattern = Array(totalSlots).fill('-'); // Reset to default if not an array
            }
        } catch (e) {
            console.error('Error parsing initial strumming pattern JSON:', e);
            strummingPattern = Array(totalSlots).fill('-'); // Reset to default on error
        }
    } else {
        // If initialPatternJson is empty (e.g., new song or no saved pattern), initialize with default length
        strummingPattern = Array(totalSlots).fill('-');
    }

    console.log('Final strumming pattern state before drawing grid:', strummingPattern); // Log before drawGrid
    // Initial drawing of the grid
    drawGrid();

    // Set the initial value of the display beats dropdown
    if (displayBeatsSelect) {
        displayBeatsSelect.value = initialDisplayBeats;
    }

</script>
{% endblock %} 